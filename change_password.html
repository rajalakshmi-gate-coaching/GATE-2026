<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Change Password</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/auth.js"></script>
    <script>requireAuth();</script> <style>
        .cp-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .back-link { display: block; text-align: center; margin-top: 15px; color: #003366; text-decoration: none; }
    </style>
</head>
<body>
    <div class="header"><h1>ACCOUNT SETTINGS</h1></div>

    <div class="cp-container">
        <h3 style="color:#003366; text-align:center;">Change Password</h3>
        <p style="color:#666; font-size:0.9rem; text-align:center;">User: <strong id="uid-disp">...</strong></p>
        
        <label>New Password</label>
        <input type="password" id="newPass" placeholder="Enter new password">
        
        <label>Confirm Password</label>
        <input type="password" id="confPass" placeholder="Repeat new password">
        
        <button class="btn" style="width:100%; background:#003366;" onclick="updatePassword()">Update Password</button>
        
        <a href="#" onclick="window.history.back()" class="back-link">Cancel & Go Back</a>
    </div>

    <script type="module">
        import { db, collection, addDoc, getDocs, query, where, doc, updateDoc, setDoc } from "./js/firebase_config.js";

        // Display ID
        const uid = localStorage.getItem("REC_USER_ID");
        document.getElementById('uid-disp').innerText = uid;

        window.updatePassword = async function() {
            const p1 = document.getElementById('newPass').value.trim();
            const p2 = document.getElementById('confPass').value.trim();

            if (p1.length < 4) { alert("Password too short!"); return; }
            if (p1 !== p2) { alert("Passwords do not match!"); return; }

            const btn = document.querySelector('button');
            btn.innerText = "Updating...";
            btn.disabled = true;

            try {
                // We use setDoc with 'merge: true' to create or overwrite the password entry
                // We store this in a special collection 'user_credentials'
                // The document ID will be the UserID (e.g., 'REC01') for easy lookup
                
                await setDoc(doc(db, "user_credentials", uid), {
                    password: p1,
                    updatedAt: new Date().toISOString()
                });

                alert("âœ… Password Updated Successfully!\n\nPlease login again with your new password.");
                localStorage.clear();
                window.location.href = "index.html";

            } catch (error) {
                console.error("Error:", error);
                alert("Failed to update password. Check internet.");
                btn.innerText = "Update Password";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>

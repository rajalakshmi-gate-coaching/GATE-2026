<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Faculty Dashboard - REC GATE 2026</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        requireAuth("FACULTY");
    </script>
</head>
<body>
    <div class="header">
        <h1>FACULTY ANALYTICS DASHBOARD</h1>
        <div style="font-size: 0.9rem; margin-top:5px;">
            Logged in as: <span id="fac-id" style="font-weight:bold; color:#FFCC00;"></span> | 
            <a href="#" onclick="localStorage.clear(); location.href='login.html'" style="color:white; text-decoration:underline;">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card" style="text-align:left;">
            <h3>ðŸ“‚ Step 1: Upload Student Response Files</h3>
            <p>Select all <code>.json</code> files sent by students.</p>
            <input type="file" multiple onchange="processFiles(this.files)" accept=".json" style="padding:10px; border:2px dashed #ccc; width:100%;">
        </div>

        <div id="analytics-section" style="display:none; margin-top: 30px;">
            <h3>ðŸ“Š Step 2: Class Statistics</h3>
            <div class="card-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="card"><h3>Total</h3><h2 id="stat-total" style="color:#003366;">0</h2></div>
                <div class="card"><h3>Avg Score</h3><h2 id="stat-avg" style="color:#003366;">0</h2></div>
                <div class="card"><h3>Max Score</h3><h2 id="stat-max" style="color:#003366;">0</h2></div>
                <div class="card"><h3>Pass %</h3><h2 id="stat-pass" style="color:#003366;">0%</h2></div>
            </div>
            
            <br>
            <button class="btn" style="background:#28a745;" onclick="exportExcel()">Download Class Report (Excel)</button>
            <br><br>
            
            <table border="1" style="width:100%; border-collapse: collapse; background:white;">
                <thead style="background:#ddd;">
                    <tr><th style="padding:8px;">ID</th><th style="padding:8px;">Score</th><th style="padding:8px;">Status</th><th style="padding:8px;">Date</th></tr>
                </thead>
                <tbody id="report-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        document.getElementById('fac-id').innerText = localStorage.getItem("REC_USER_ID");
        let globalData = [];

        function processFiles(files) {
            let totalScore = 0, maxScore = 0, passCount = 0, processed = 0;
            globalData = [];
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = "";

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        const score = json.scoreData.totalScore;
                        
                        totalScore += score;
                        if(score > maxScore) maxScore = score;
                        if(score >= 40) passCount++; 

                        tbody.innerHTML += `<tr>
                            <td style="padding:8px;">${json.user}</td>
                            <td style="padding:8px;"><strong>${score}</strong></td>
                            <td style="padding:8px; color:${score >= 40 ? 'green':'red'}">${score >= 40 ? 'PASS':'FAIL'}</td>
                            <td style="padding:8px;">${new Date(json.date).toLocaleString()}</td>
                        </tr>`;

                        globalData.push({ "Student ID": json.user, "Score": score, "Status": score >= 40 ? 'PASS':'FAIL', "Date": new Date(json.date).toLocaleString() });
                        processed++;

                        if(processed === files.length) {
                            document.getElementById('analytics-section').style.display = 'block';
                            document.getElementById('stat-total').innerText = processed;
                            document.getElementById('stat-avg').innerText = (totalScore / processed).toFixed(2);
                            document.getElementById('stat-max').innerText = maxScore;
                            document.getElementById('stat-pass').innerText = Math.round((passCount/processed)*100) + "%";
                        }
                    } catch(err) { console.error("Bad File", err); }
                };
                reader.readAsText(file);
            });
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(globalData);
            XLSX.utils.book_append_sheet(wb, ws, "Class_Stats");
            XLSX.writeFile(wb, "REC_Faculty_Class_Report.xlsx");
        }
    </script>
</body>
</html>

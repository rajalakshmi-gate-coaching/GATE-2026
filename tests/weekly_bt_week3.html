<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Test 3 - Exam Server</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #003366; --success: #28a745; --danger: #dc3545; --light: #f8f9fa; --dark: #343a40; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--light); color: #333; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .timer { font-family: 'Courier New', monospace; font-size: 1.4rem; font-weight: bold; color: #ffcc00; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 5px; }

        /* Navigation Tabs */
        .tabs { display: flex; background: white; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: 600; color: #6c757d; transition: 0.3s; border-bottom: 4px solid transparent; }
        .tab:hover { background: #f1f3f5; }
        .tab.active { color: var(--primary); border-bottom: 4px solid var(--primary); background: #eef4fb; }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* Question Area */
        .q-area { flex: 1; padding: 40px; overflow-y: auto; background: white; }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 15px; }
        .q-badge { background: #333; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; margin-right: 10px; }
        .q-text { font-size: 1.25rem; line-height: 1.6; margin-bottom: 20px; }
        .q-extra-info { background: #eef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary); }
        
        /* Options */
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option-label { display: flex; align-items: center; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 1.05rem; }
        .option-label:hover { border-color: var(--primary); background: #f8fbff; }
        .option-label input { margin-right: 15px; transform: scale(1.3); }
        .nat-input { padding: 12px; font-size: 1.2rem; border: 2px solid var(--primary); border-radius: 6px; width: 250px; outline: none; }

        /* Sidebar */
        .sidebar { width: 320px; background: #fff; border-left: 1px solid #dee2e6; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
        .user-panel { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; text-align: center; }
        .palette { flex: 1; padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-content: start; }
        .p-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; background: white; }
        .p-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .p-btn.active { border: 2px solid var(--primary); color: var(--primary); }
        .p-btn.answered { background: var(--success); color: white; border-color: var(--success); }
        .p-btn.visited { background: var(--danger); color: white; border-color: var(--danger); }

        /* Footer */
        footer { padding: 15px 30px; background: white; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-prev { background: #6c757d; }
        .btn-next { background: var(--primary); }
        .btn-submit { background: var(--success); width: 100%; margin-top: 15px; padding: 15px; font-size: 1.1rem; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .score-box { background: #f1f3f5; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .score-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 1.1rem; }
    </style>
</head>
<body>

    <header>
        <div><strong>Weekly Test 3</strong> | Online Examination</div>
        <div class="timer" id="timer">180:00</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchSection('GA')">General Aptitude (GA)</div>
        <div class="tab" onclick="switchSection('BT')">Biotechnology (BT)</div>
    </div>

    <div class="container">
        <div class="q-area">
            <div class="q-header">
                <div>
                    <span class="q-badge" id="disp-type">MCQ</span>
                    <strong style="font-size: 1.4rem;">Question <span id="disp-num">1</span></strong>
                    <span style="color:#6c757d; font-size:0.9rem; margin-left:10px;">ID: <span id="disp-qid"></span></span>
                </div>
                <div style="color: var(--success); font-weight: bold; font-size:1.1rem;" id="disp-marks">+1 Mark</div>
            </div>
            <div class="q-text" id="disp-text"></div>
            <div id="disp-extra" class="q-extra-info" style="display:none;"></div>
            <div class="options" id="disp-options"></div>
        </div>

        <div class="sidebar">
            <div class="user-panel">
                <div style="font-weight:bold; font-size:1.2rem;">Candidate Console</div>
                <div style="font-size:0.9rem; color:#6c757d; margin-top:5px;" id="user-id-disp">Guest User</div>
            </div>
            <div class="palette" id="palette"></div>
            <div style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa;">
                <button class="btn btn-submit" onclick="submitExam()">Submit & Upload</button>
            </div>
        </div>
    </div>

    <footer>
        <button class="btn btn-prev" onclick="nav(-1)">Previous</button>
        <button class="btn btn-next" onclick="nav(1)">Save & Next</button>
    </footer>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary);">Exam Submitted</h2>
            <p>Your response data has been processed.</p>
            
            <div class="score-box">
                <div class="score-row" style="font-weight:bold; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <span>Total Score</span>
                    <span id="final-total" style="color:var(--primary)">0</span>
                </div>
                <div class="score-row"><span>General Aptitude (GA)</span> <span id="score-ga">0</span></div>
                <div class="score-row"><span>Biotechnology (BT)</span> <span id="score-bt">0</span></div>
            </div>

            <button class="btn btn-next" onclick="location.reload()">Close & Reset</button>
        </div>
    </div>

    <div id="loadingModal" class="modal" style="z-index: 3000;">
        <div style="color:white; font-size:1.5rem; font-weight:bold;">
            Uploading Results... <br>
            <span style="font-size:1rem; font-weight:normal;">Please wait...</span>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // --- FIREBASE CONFIGURATION ---
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Configuration provided by user
        const firebaseConfig = {
            apiKey: "AIzaSyAmKDzGKE9FV9A7wHG21yAbgzIYMep4iHo",
            authDomain: "rec-gate-2026.firebaseapp.com",
            projectId: "rec-gate-2026",
            storageBucket: "rec-gate-2026.firebasestorage.app",
            messagingSenderId: "966656816540",
            appId: "1:966656816540:web:f07b7b6e2cb27114cc8459"
        };

        // Initialize Firebase safely
        let dbRef = null;
        try {
            const app = initializeApp(firebaseConfig);
            dbRef = getFirestore(app);
            console.log("Firebase Initialized Successfully");
        } catch (e) {
            console.warn("Firebase Init Error: Running in Offline Mode.", e);
        }

        // Expose functions to global window scope
        window.submitExam = submitExam;
        window.nav = nav;
        window.switchSection = switchSection;
        window.save = save;
        window.saveMSQ = saveMSQ;
        window.saveNAT = saveNAT;
        window.loadQ = loadQ;

        // ==========================================
        // --- DATA & LOGIC ---
        // ==========================================
        // Data parsed from "WEEKLY TEST 3- Template.xlsx - WEEKLY TEST 3 29.12.25.csv"
        const rawData = [
  { "id": "GA1", "section": "GA", "marks": 1.0, "type": "MCQ", "q": "If det(A)=0, then the system Ax=b is", "opts": ["Consistent only", "Inconsistent only", "May or may not have solution", "Has unique solution"], "correct": 2 },
  { "id": "GA2", "section": "GA", "marks": 1.0, "type": "MCQ", "q": "If A is an n\u00d7n matrix, then rank(A)+nullity(A) equals", "opts": ["n", "2n", "rank(A)", "nullity(A)"], "correct": 0 },
  { "id": "GA3", "section": "GA", "marks": 1.0, "type": "MCQ", "q": "If A is orthogonal, then A\u1d40A equals", "opts": ["A", "I", "0", "A\u00b2"], "correct": 1 },
  { "id": "GA4", "section": "GA", "marks": 1.0, "type": "MCQ", "q": "Eigenvalues of a triangular matrix are its", "opts": ["Diagonal elements", "Row sums", "Column sums", "Trace"], "correct": 0 },
  { "id": "GA5", "section": "GA", "marks": 1.0, "type": "MCQ", "q": "If A is skew-symmetric, then its diagonal elements are", "opts": ["Positive", "Negative", "Zero", "Non-zero"], "correct": 2 },
  { "id": "GA6", "section": "GA", "marks": 2.0, "type": "MCQ", "q": "If A is symmetric, then its eigenvalues are", "opts": ["Complex", "Pure imaginary", "Real", "Zero only"], "correct": 2 },
  { "id": "GA7", "section": "GA", "marks": 2.0, "type": "MCQ", "q": "If \u03bb is an eigenvalue of A, then eigenvalue of kA is", "opts": ["\u03bb/k", "k\u03bb", "\u03bb\u00b2", "\u03bb+k"], "correct": 1 },
  { "id": "GA8", "section": "GA", "marks": 2.0, "type": "MCQ", "q": "If A\u00b2=A, then A is called", "opts": ["Symmetric", "Idempotent", "Orthogonal", "Singular"], "correct": 1 },
  { "id": "GA9", "section": "GA", "marks": 2.0, "type": "MCQ", "q": "If A is positive definite, then its eigenvalues are", "opts": ["Negative", "Zero", "Positive", "Complex"], "correct": 2 },
  { "id": "GA10", "section": "GA", "marks": 2.0, "type": "MCQ", "q": "The determinant of an orthogonal matrix is", "opts": ["0", "1", "\u00b11", "2"], "correct": 2 },
  { "id": "BT11", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Which histones form the core of the nucleosome?", "opts": ["H1, H2A, H2B, H3", "H2A, H2B, H3, H4", "H1, H3, H4, H5", "H2A, H3, H4, H5"], "correct": 1 },
  { "id": "BT12", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Mitochondrial DNA is", "opts": ["Linear and histone-bound", "Circular and histone-free", "Linear and histone-free", "Circular and histone-bound"], "correct": 1 },
  { "id": "BT13", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Which component of a flow cytometer is responsible for aligning cells in a single file?", "opts": ["Photomultiplier tube", "Detector", "Fluidics system", "Optical filter"], "correct": 2 },
  { "id": "BT14", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Side scatter (SSC) in flow cytometry mainly reflects:", "opts": ["Cell size", "Cell viability", "Antibody binding affinity", "Cell internal complexity or granularity"], "correct": 3 },
  { "id": "BT15", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Ubiquitin-mediated regulation affects gene expression at the level of", "opts": ["A.Transcription", "B. mRNA processing", "C. Protein degradation", "D. Chromatin condensation"], "correct": 2 },
  { "id": "BT16", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "A point mutation converts the codon UAU to UAA in an mRNA sequence. What is the most likely effect on the protein?", "opts": ["A. No change in amino acid", "B. Substitution of tyrosine with phenylalanine", "C. Premature termination of translation", "D. Elongation of the polypeptide"], "correct": 2 },
  { "id": "BT17", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "UV radiation causes the formation of thymine dimers. Which cellular process is directly affected if these lesions are not repaired?", "opts": ["A. Transcription factor binding", "B. DNA replication fidelity", "C. mRNA splicing", "D. Ribosome assembly"], "correct": 1 },
  { "id": "BT18", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Which biomolecule primarily forms the fluid mosaic model of cell membranes?", "opts": ["A) Proteins", "B) Phospholipids", "C) Cholesterol", "D) Carbohydrates"], "correct": 1 },
  { "id": "BT19", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "The Michaelis constant (Km) in enzyme kinetics represents:", "opts": ["A) Maximum velocity", "B) Substrate concentration at half Vmax", "C) Inhibitor concentration", "D) Turnover number"], "correct": 3 },
  { "id": "BT20", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Nitrogen fixation in bacteria is primarily carried out by:", "opts": ["A) Nitrosomonas", "B) Rhizobium", "C) Azotobacter", "D) Both B and C"], "correct": 1 },
  { "id": "BT21", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Cholesterol decreases membrane fluidity at all temperatures.", "opts": ["True", "False", "N/A", "N/A"], "correct": 0 },
  { "id": "BT22", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Satellite DNA sequences are highly repetitive and non-coding?", "opts": ["True", "False", "N/A", "N/A"], "correct": 0 },
  { "id": "BT23", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Fluid mosaic model includes integral proteins that function as channels and pumps.", "opts": ["True", "False", "N/A", "N/A"], "correct": 0 },
  { "id": "BT24", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Non-competitive inhibition affects both Km and Vmax equally", "opts": ["True", "False", "N/A", "N/A"], "correct": 0 },
  { "id": "BT25", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Innate immunity includes memory cells like adaptive immunity.", "opts": ["True", "False", "N/A", "N/A"], "correct": 0 },
  { "id": "BT26", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "List-I: P) Phospholipid Q) Cholesterol R) Glycoprotein S) Nucleotide\nList-II: 1) Membrane fluidity 2) Bilayer backbone 3) Cell recognition 4) Genetic code", "opts": ["P-1,Q-2,R-4,S-3", "P-3,Q-4,R-1,S-2", "P-4,Q-3,R-2,S-1", "P-2, Q-1, R-3, S-4"], "correct": 3 },
  { "id": "BT27", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "List-I: P) Glycolysis Q) TCA cycle R) Beta-oxidation S) Gluconeogenesis\nList-II: 1) Fatty acids 2) Glucose to pyruvate 3) Pyruvate oxidation 4) Glucose synthesis", "opts": ["P-1,Q-2,R-3,S-4", "P-3,Q-1,R-4,S-2", "P-4,Q-3,R-2,S-1", "P-2, Q-3, R-1, S-4"], "correct": 3 },
  { "id": "BT28", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "List-I: P) Gram+ve Q) Archaea R) Mycoplasma S) Rhizobium\nList-II: 1) No cell wall 2) Symbiotic N2 fixation 3) Thick peptidoglycan 4) Ether lipids", "opts": ["P-2,Q-3,R-4,S-1", "P-1,Q-4,R-3,S-2", "P-4,Q-1,R-2,S-3", "P-3, Q-4, R-1, S-2"], "correct": 3 },
  { "id": "BT29", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "List-I: P) IgM Q) T helper R) Complement C3 S) MHC I\nList-II: 1) Cytotoxic response 2) First antibody 3) Opsonization 4) Intracellular antigens", "opts": ["P-1,Q-3,R-2,S-4", "P-4,Q-1,R-3,S-2", "P-3,Q-4,R-1,S-2", "P-2, Q-1, R-3, S-4"], "correct": 3 },
  { "id": "BT30", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "List-I: P) Competitive Q) Non-competitive R) Km S) Vmax\nList-II: 1) Affected by inhibitor 2) Substrate affinity 3) Vmax unchanged 4) Maximum rate", "opts": ["P-2,Q-4,R-1,S-3", "P-4,Q-3,R-2,S-1", "P-1,Q-2,R-4,S-3", "P-3, Q-1, R-2, S-4"], "correct": 3 },
  { "id": "BT31", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "A: The trp operon is an inducible operon.    R: Tryptophan acts as a corepressor and activates the repressor protein.", "opts": ["A. Both A and R are true and R is the correct explanation of A", "B. Both A and R are true but R is not the correct explanation of A", "C. A is true but R is false", "D. A is false but R is true"], "correct": 3 },
  { "id": "BT32", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "A: Flow cytometry can analyze thousands of cells per second. R: Cells are analyzed individually in a continuous fluid stream.", "opts": ["Both true, but R does not explain A", "Both A and R true, R explains A", "A true, R false", "A false, R true"], "correct": 1 },
  { "id": "BT33", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "Which one of the following features is unique to FACS but not present in basic flow cytometry?", "opts": ["Fluorescence detection", "Forward and side scatter measurement", "Hydrodynamic focusing", "Electrostatic deflection of droplets"], "correct": 3 },
  { "id": "BT34", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "A: Satellite DNA is highly repetitive and non-coding.\nR: Satellite DNA forms centromeres and telomeres for chromosome stability.", "opts": ["(a) Both A and R true, R explains A\n(b) Both A and R true, R does not explain A\n(c) A true, R false\n(d) A false, R true", "N/A", "N/A", "N/A"], "correct": 0 },
  { "id": "BT35", "section": "BT", "marks": 1.0, "type": "MCQ", "q": "A: Competitive inhibitors increase Km but Vmax remains unchanged.\nR: Competitive inhibitors compete with substrate for active site binding.", "opts": ["(a) Both A and R true, R explains A\n(b) Both A and R true, R does not explain A\n(c) A true, R false\n(d) A false, R true", "N/A", "N/A", "N/A"], "correct": 0 },
  { "id": "BT36", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "In photosynthesis, the light-dependent reactions produce:", "opts": ["A) ATP and NADPH only", "B) ATP, NADPH, and O2", "C) Glucose and CO2", "D) RuBP and PGA"], "correct": 1 },
  { "id": "BT37", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Which of the following is a competitive inhibitor of an enzyme?", "opts": ["A) Binds irreversibly to active site", "B) Increases Km without affecting Vmax", "C) Decreases Vmax without affecting Km", "D) Binds to allosteric site"], "correct": 1 },
  { "id": "BT38", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "In adaptive immunity, T cell receptors recognize antigens presented by:", "opts": ["A) MHC Class I only", "B) MHC Class II only", "C) Both MHC I and II", "D) Free antigens"], "correct": 2 },
  { "id": "BT39", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Bacterial cell wall in Gram-positive bacteria mainly contains:", "opts": ["A) Lipopolysaccharides", "B) Teichoic acids", "C) Porins", "D) Periplasmic space"], "correct": 1 },
  { "id": "BT40", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Hypersensitivity type II is mediated by:", "opts": ["A) IgE", "B) IgG or IgM", "C) T cells", "D) Complement only"], "correct": 1 },
  { "id": "BT41", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "In microbial growth curve, stationary phase is characterized by:", "opts": ["A) Balanced growth", "B) Death phase dominance", "C) Nutrient exhaustion balancing division", "D) Logarithmic increase"], "correct": 2 },
  { "id": "BT42", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Column I   A. Alternative splicing    B.mi RNA       C. Poly-A tail              D. RNA editing", "opts": ["Column II     1. mRNA stability control  2. Protein diversity   3. Translation inhibition  4. Alters nucleotide sequence", "A\u20134, B\u20133, C\u20132, D\u20131", "A\u20131, B\u20133, C\u20132, D\u20134", "A\u20132, B\u20133, C\u20131, D\u20134"], "correct": 0 },
  { "id": "BT43", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "List-I: P) DNA polymerase, Q) Lactate dehydrogenase, R) Trypsin, S) Lipase\nList-II: 1) Oxidoreductase, 2) Transferase, 3) Hydrolase, 4) Polymerase", "opts": ["P-1, Q-4, R-3, S-2", "P-3, Q-1, R-4, S-3", "P-4, Q-3, R-1, S-2", "P-4, Q-1, R-3, S-3"], "correct": 0 },
  { "id": "BT44", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Column I: A. Sheath fluid B. LASER C. Photomultiplier tube D. Computer", "opts": ["Column II: 1. Signal amplification 2. Hydrodynamic focusing 3. Excitation of fluorophore 4. Data analysis", "A-1, B-2, C-3, D-4", "A-2, B-3, C-1, D-4", "A-4, B-3, C-2, D-1"], "correct": 0 },
  { "id": "BT45", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "List-I: P) DNA virus Q) Enveloped R) ssRNA+ S) Baltimore I\nList-II: 1) mRNA genome 2) dsDNA 3) Lipid membrane 4) Reverse transcriptase", "opts": ["P-4,Q-1,R-3,S-2", "P-3,Q-4,R-2,S-1", "P-1,Q-2,R-4,S-3", "P-2, Q-3, R-1, S-2"], "correct": 0 },
  { "id": "BT46", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "List-I: P) Quorum sensing Q) Biofilm R) Nitrogenase S) Symbiosis\nList-II: 1) N2 fixation 2) Cell communication 3) Surface communities 4) Mutual benefit", "opts": ["P-1,Q-4,R-2,S-3", "P-3,Q-1,R-4,S-2", "P-4,Q-3,R-1,S-2", "P-2, Q-3, R-1, S-4"], "correct": 0 },
  { "id": "BT47", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "In the fluid mosaic model of membranes, which TWO statements are correct?", "opts": ["A) Phospholipids form a bilayer with hydrophilic heads outward\nB) Integral proteins span the bilayer as channels/pumps\nC) Cholesterol decreases membrane fluidity at all temperatures\nD) Glycocalyx provides cell-cell recognition", "(A,B)", "(A,C)", "(B,D)"], "correct": 2 },
  { "id": "BT48", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Michaelis-Menten kinetics for competitive inhibition shows:", "opts": ["A) Increased Km, unchanged Vmax", "B) Decreased Vmax, unchanged Km", "C) Both Km and Vmax decreased", "D) No effect on either parameter"], "correct": 0 },
  { "id": "BT49", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Nitrogen fixation by Rhizobium requires:", "opts": ["A) Oxygen-free environment and leghemoglobin", "B) Photosynthetic bacteria only", "C) High nitrate soil conditions", "D) Anaerobic respiration exclusively"], "correct": 0 },
  { "id": "BT50", "section": "BT", "marks": 2.0, "type": "MCQ", "q": "Antibody diversity generation involves:", "opts": ["A) V(D)J recombination in B cells", "B) Somatic hypermutation during affinity maturation", "C) Class switch recombination for isotype change", "D) All of the above"], "correct": 0 },
  { "id": "BT51", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Which are components of ETC in respiration? A) Complex I B) Rubisco C) Cytochrome c D) ATP synthase E) Calvin cycle", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0] },
  { "id": "BT52", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Antibiotic resistance mechanisms include: A) Efflux pumps B) Beta-lactamase C) Ribosomal mutation D) Photosynthetic inhibition", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0] },
  { "id": "BT53", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Which proteins are general transcription factors for RNA polymerase II?", "opts": ["A. TFIID", "B. TFIIH", "C. CAP protein", "D. TFIIB"], "correct": [0, 1, 3] },
  { "id": "BT54", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Histone acetylation generally results in", "opts": ["A. Loosening of chromatin structure", "B. Increased transcription", "C. Formation of heterochromatin", "D. Neutralization of positive charges on histones"], "correct": [0, 1, 3] },
  { "id": "BT55", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "A mutation occurs in the promoter region of a gene. Which effects are expected?", "opts": ["A. Altered transcription rate", "B. No change in amino acid sequence", "C. Defective mRNA splicing", "D. Changed gene expression level"], "correct": [0, 1, 3] },
  { "id": "BT56", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Antibody diversity arises from: A) V(D)J recombination B) Somatic hypermutation C) Class switching D) MHC polymorphism", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0, 1, 2] },
  { "id": "BT57", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Microbial ecology interactions: A) Symbiosis B) Quorum sensing C) Predation D) Nitrogen fixation only", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0, 1, 2] },
  { "id": "BT58", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Host-pathogen interactions involve: A) Adhesins B) Toxins C) Phagocytosis D) cytokinesis", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0, 1, 2] },
  { "id": "BT59", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Vaccines types: A) Live attenuated B) Toxoid C) RNAi vaccine D) Carbohydrate conjugate", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0, 1, 3] },
  { "id": "BT60", "section": "BT", "marks": 2.0, "type": "MSQ", "q": "Metabolism pathways for carbohydrates: A) Glycolysis B) TCA cycle C) Beta-oxidation D) Gluconeogenesis", "opts": ["N/A", "N/A", "N/A", "N/A"], "correct": [0, 1, 3] },
  { "id": "BT61", "section": "BT", "marks": 2.0, "type": "NAT", "q": "In Lineweaver-Burk plot, if Km=0.5 mM and Vmax=100 \u00b5mol/min, find 1/Km value.", "correct": [2.0, 2.0] },
  { "id": "BT62", "section": "BT", "marks": 2.0, "type": "NAT", "q": "A bacterial culture doubles every 20 min; find generation time if population reaches 1024 from 1 cell.", "correct": [10.0, 10.0] },
  { "id": "BT63", "section": "BT", "marks": 2.0, "type": "NAT", "q": "Antibody has 2 heavy and 2 light chains; find total domains in IgG Fab region.", "correct": [6.0, 6.0] },
  { "id": "BT64", "section": "BT", "marks": 2.0, "type": "NAT", "q": "In nitrogen fixation, N2 + 8e- + 8H+ + 16 ATP \u2192 2NH3 + H2; find ATP molecules per N2.", "correct": [16.0, 16.0] },
  { "id": "BT65", "section": "BT", "marks": 2.0, "type": "NAT", "q": "Photosystem II absorbs at wavelength __ nm.", "correct": [680.0, 680.0] }
];

        let responses = {};
        let currentSec = 'GA';
        let currentIdx = 0;
        let visited = new Set();
        let questions = [];

        function init() {
            // Get user from local storage or set guest
            const user = localStorage.getItem("REC_USER_ID") || "GUEST";
            document.getElementById("user-id-disp").innerText = user;

            switchSection('GA');
            
            setInterval(() => {
                let t = document.getElementById('timer');
                let [m, s] = t.innerText.split(':').map(Number);
                if (s === 0) { if (m === 0) return; m--; s = 59; } else s--;
                t.innerText = `${m}:${s < 10 ? '0' + s : s}`;
            }, 1000);
        }

        function switchSection(sec) {
            currentSec = sec;
            questions = rawData.filter(q => q.section === sec);
            currentIdx = 0;
            document.querySelectorAll('.tab').forEach(t => {
                t.className = t.innerText.includes(sec) ? 'tab active' : 'tab';
            });
            renderPalette();
            loadQ(0);
        }

        function loadQ(idx) {
            currentIdx = idx;
            let q = questions[idx];
            visited.add(q.id);
            
            document.getElementById('disp-num').innerText = idx + 1;
            document.getElementById('disp-qid').innerText = q.id;
            document.getElementById('disp-type').innerText = q.type;
            document.getElementById('disp-marks').innerText = `+${q.marks} Mark${q.marks > 1 ? 's' : ''}`;
            document.getElementById('disp-text').innerHTML = q.q;

            // Handle special questions where options are all in one string
            const extraDiv = document.getElementById('disp-extra');
            let displayOpts = q.opts;
            
            if ((q.type === 'MCQ' || q.type === 'MSQ') && q.opts.length === 1 && q.opts[0].length > 10) {
                // If options are bunched together in index 0, show them in text box
                extraDiv.style.display = 'block';
                extraDiv.innerHTML = "<strong>Options:</strong><br>" + q.opts[0].replace(/\n/g, "<br>");
                // Provide standard A, B, C, D buttons
                displayOpts = ["Option A", "Option B", "Option C", "Option D"];
            } else if ((q.type === 'MCQ' || q.type === 'MSQ') && q.opts.length > 0 && q.opts[0] === "N/A") {
                 // For questions with missing option text in CSV, show generic buttons
                 extraDiv.style.display = 'block';
                 extraDiv.innerHTML = "<em>(Options text not available in source data. Please select A, B, C, or D based on question text.)</em>";
                 displayOpts = ["Option A", "Option B", "Option C", "Option D"];
            } else {
                extraDiv.style.display = 'none';
            }

            let optsDiv = document.getElementById('disp-options');
            optsDiv.innerHTML = '';

            let saved = responses[q.id];

            if (q.type === 'MCQ') {
                displayOpts.forEach((opt, i) => {
                    let checked = saved === i ? 'checked' : '';
                    optsDiv.innerHTML += `<label class="option-label"><input type="radio" name="ans" value="${i}" onclick="save(${i})" ${checked}> ${opt}</label>`;
                });
            } else if (q.type === 'MSQ') {
                displayOpts.forEach((opt, i) => {
                    let checked = (saved || []).includes(i) ? 'checked' : '';
                    optsDiv.innerHTML += `<label class="option-label"><input type="checkbox" value="${i}" onclick="saveMSQ(this, ${i})" ${checked}> ${opt}</label>`;
                });
            } else if (q.type === 'NAT') {
                optsDiv.innerHTML = `<input type="number" class="nat-input" onblur="saveNAT(this)" value="${saved || ''}" placeholder="Enter Numerical Answer">`;
            }
            
            if(window.MathJax) MathJax.typeset();
            renderPalette();
        }

        function save(val) { responses[questions[currentIdx].id] = val; renderPalette(); }
        
        function saveMSQ(el, val) {
            let id = questions[currentIdx].id;
            let arr = responses[id] || [];
            if (el.checked) arr.push(val); else arr = arr.filter(x => x !== val);
            responses[id] = arr;
            renderPalette();
        }
        
        function saveNAT(el) { 
            let val = parseFloat(el.value);
            if (!isNaN(val)) responses[questions[currentIdx].id] = val; 
            renderPalette();
        }

        function renderPalette() {
            let p = document.getElementById('palette');
            p.innerHTML = '';
            questions.forEach((q, i) => {
                let cls = 'p-btn';
                if (i === currentIdx) cls += ' active';
                if (responses[q.id] !== undefined) cls += ' answered';
                else if (visited.has(q.id)) cls += ' visited';
                p.innerHTML += `<div class="${cls}" onclick="loadQ(${i})">${i + 1}</div>`;
            });
        }

        function nav(dir) {
            let next = currentIdx + dir;
            if (next >= 0 && next < questions.length) loadQ(next);
        }

        // ==========================================
        // --- SCORE & UPLOAD LOGIC ---
        // ==========================================
        async function submitExam() {
            if (!confirm("Are you sure you want to submit? This will upload your data.")) return;

            const modal = document.getElementById('loadingModal');
            modal.style.display = 'flex';

            let totalScore = 0;
            let sectionScores = { "GA": 0, "BT": 0 };
            
            rawData.forEach(q => {
                let ans = responses[q.id];
                let points = 0;
                
                if (ans !== undefined) {
                    let isCorrect = false;
                    
                    if (q.type === 'MCQ' && ans === q.correct) isCorrect = true;
                    else if (q.type === 'MSQ' && JSON.stringify(ans.sort()) === JSON.stringify(q.correct.sort())) isCorrect = true;
                    else if (q.type === 'NAT' && ans >= q.correct[0] && ans <= q.correct[1]) isCorrect = true;
                    
                    if (isCorrect) {
                        points = q.marks;
                    } else if (q.type === 'MCQ') {
                        // Optional: Negative Marking (1/3rd of marks)
                        // points = -(q.marks / 3);
                    }
                }

                if (points !== 0) {
                    totalScore += points;
                    if (sectionScores[q.section] !== undefined) sectionScores[q.section] += points;
                }
            });

            // Update UI
            document.getElementById('final-total').innerText = totalScore.toFixed(2);
            document.getElementById('score-ga').innerText = sectionScores["GA"].toFixed(2);
            document.getElementById('score-bt').innerText = sectionScores["BT"].toFixed(2);

            // Upload Logic with Timeout Fallback
            if (dbRef) {
                const payload = {
                    student_id: localStorage.getItem("REC_USER_ID") || "GUEST",
                    exam_name: "WEEKLY_TEST_3_29_DEC",
                    total_score: totalScore,
                    section_scores: sectionScores,
                    timestamp: new Date().toISOString(),
                    responses: JSON.stringify(responses)
                };

                try {
                    // Timeout Promise (5 seconds)
                    const timeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Upload Timeout")), 5000)
                    );
                    
                    // Race between Upload and Timeout
                    await Promise.race([
                        addDoc(collection(dbRef, "exam_results"), payload),
                        timeout
                    ]);
                    
                    console.log("Uploaded successfully");
                } catch (e) {
                    console.warn("Upload skipped or failed (likely offline). Showing local results.");
                }
            }

            modal.style.display = 'none';
            document.getElementById('resultModal').style.display = 'flex';
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE 2021 (XL) - Exam Server & Database</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --light: #f8f9fa; --dark: #343a40; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--light); color: var(--dark); }
        
        /* Header */
        header { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .timer { font-family: 'Courier New', monospace; font-size: 1.4rem; font-weight: bold; color: #ffc107; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 5px; }

        /* Navigation Tabs */
        .tabs { display: flex; background: white; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: 600; color: #6c757d; transition: 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: #f1f3f5; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #e7f1ff; }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* Question Area */
        .q-area { flex: 1; padding: 40px; overflow-y: auto; background: white; }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 15px; }
        .q-badge { background: var(--dark); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; margin-right: 10px; }
        .q-text { font-size: 1.25rem; line-height: 1.6; margin-bottom: 30px; }
        
        /* Options */
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option-label { display: flex; align-items: center; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 1.05rem; }
        .option-label:hover { border-color: var(--primary); background: #f8fbff; }
        .option-label input { margin-right: 15px; transform: scale(1.3); }
        .nat-input { padding: 12px; font-size: 1.2rem; border: 2px solid var(--primary); border-radius: 6px; width: 250px; outline: none; }

        /* Sidebar */
        .sidebar { width: 320px; background: #fff; border-left: 1px solid #dee2e6; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
        .user-panel { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; text-align: center; }
        .palette { flex: 1; padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-content: start; }
        .p-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; background: white; }
        .p-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .p-btn.active { border: 2px solid var(--primary); color: var(--primary); }
        .p-btn.answered { background: var(--success); color: white; border-color: var(--success); }
        .p-btn.visited { background: var(--danger); color: white; border-color: var(--danger); }

        /* Footer */
        footer { padding: 15px 30px; background: white; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-prev { background: #6c757d; }
        .btn-next { background: var(--primary); }
        .btn-submit { background: var(--success); width: 100%; margin-top: 15px; padding: 15px; font-size: 1.1rem; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .score-box { background: #f1f3f5; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .score-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 1.1rem; }
    </style>
</head>
<body>

    <header>
        <div><strong>GATE 2021 (XL)</strong> | Life Sciences CBT</div>
        <div class="timer" id="timer">180:00</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchSection('XL-P')">XL-P: Chemistry</div>
        <div class="tab" onclick="switchSection('XL-S')">XL-S: Microbiology</div>
        <div class="tab" onclick="switchSection('XE-G')">XE-G: Food Tech</div>
    </div>

    <div class="container">
        <div class="q-area">
            <div class="q-header">
                <div>
                    <span class="q-badge" id="disp-type">MCQ</span>
                    <strong style="font-size: 1.4rem;">Question <span id="disp-num">1</span></strong>
                    <span style="color:#6c757d; font-size:0.9rem; margin-left:10px;">ID: <span id="disp-qid"></span></span>
                </div>
                <div style="color: var(--success); font-weight: bold; font-size:1.1rem;" id="disp-marks">+1 Mark</div>
            </div>
            <div class="q-text" id="disp-text"></div>
            <div class="options" id="disp-options"></div>
        </div>

        <div class="sidebar">
            <div class="user-panel">
                <div style="font-weight:bold; font-size:1.2rem;">Candidate Console</div>
                <div style="font-size:0.9rem; color:#6c757d; margin-top:5px;" id="user-id-disp">Guest User</div>
            </div>
            <div class="palette" id="palette"></div>
            <div style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa;">
                <button class="btn btn-submit" onclick="submitExam()">Submit & Upload</button>
            </div>
        </div>
    </div>

    <footer>
        <button class="btn btn-prev" onclick="nav(-1)">Previous</button>
        <button class="btn btn-next" onclick="nav(1)">Save & Next</button>
    </footer>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary);">Exam Submitted Successfully</h2>
            <p>Your data has been uploaded to the database.</p>
            
            <div class="score-box">
                <div class="score-row" style="font-weight:bold; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <span>Total Score</span>
                    <span id="final-total" style="color:var(--primary)">0</span>
                </div>
                <div class="score-row"><span>Chemistry (XL-P)</span> <span id="score-p">0</span></div>
                <div class="score-row"><span>Microbiology (XL-S)</span> <span id="score-s">0</span></div>
                <div class="score-row"><span>Food Tech (XE-G)</span> <span id="score-g">0</span></div>
            </div>

            <button class="btn btn-next" onclick="location.reload()">Close & Reset</button>
        </div>
    </div>

    <div id="loadingModal" class="modal" style="z-index: 3000;">
        <div style="color:white; font-size:1.5rem; font-weight:bold;">
            Uploading Results... <br>
            <span style="font-size:1rem; font-weight:normal;">Please wait...</span>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // --- FIREBASE CONFIGURATION (REQUIRED) ---
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            // ⚠️ PASTE YOUR FIREBASE KEYS HERE ⚠️
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase
        let dbRef;
        try {
            const app = initializeApp(firebaseConfig);
            dbRef = getFirestore(app);
            console.log("Firebase Initialized");
        } catch (e) {
            console.error("Firebase Config Error: Update the firebaseConfig object in the code.");
        }

        // Expose functions to global window scope for HTML onclick access
        window.submitExam = submitExam;
        window.nav = nav;
        window.switchSection = switchSection;
        window.save = save;
        window.saveMSQ = saveMSQ;
        window.saveNAT = saveNAT;
        window.loadQ = loadQ;

        // ==========================================
        // --- DATA & LOGIC ---
        // ==========================================
        const db = [
             // === XL-P: CHEMISTRY ===
            { id: "P1", sec: "XL-P", type: "MCQ", marks: 1, q: "The geometry of $Fe(CO)_5$ is (Given: Atomic number of Fe = 26)", opts: ["pentagonal planar", "square pyramidal", "trigonal bipyramidal", "trigonal pyramidal"], correct: 2 },
            { id: "P2", sec: "XL-P", type: "MCQ", marks: 1, q: "The structure of the major product Q of the reaction: (1) Mg, dry Et2O; (2) D2O on a Bromine substituted ring.", opts: ["Deuterated product (D)", "Alcohol product (OD)", "MgOD intermediate", "Dimer"], correct: 0 },
            { id: "P3", sec: "XL-P", type: "NAT", marks: 1, q: "The time taken by a first order reaction to reach 90% completion is 20 s. The time taken for the reaction to reach 50% completion is ___ s (rounded off to closest integer).", correct: [6, 6] },
            { id: "P4", sec: "XL-P", type: "NAT", marks: 1, q: "Ground state energy of H atom is -13.60 eV. The energy of the electron in the third excited state is ___ eV (rounded off to two decimal places).", correct: [-0.85, -0.85] },
            { id: "P5", sec: "XL-P", type: "NAT", marks: 1, q: "Absorbance 0.42 at 275 nm, path 0.1 dm (1 cm). Molar absorptivity 8.4 x 10^3. Concentration is X * 10^-5 M. Find X.", correct: [5, 5] },
            { id: "P6", sec: "XL-P", type: "MCQ", marks: 2, q: "The CORRECT order of acidity of the given compounds (I, II, III).", opts: ["II > I > III", "II > III > I", "III > II > I", "III > I > II"], correct: 0 },
            { id: "P7", sec: "XL-P", type: "MCQ", marks: 2, q: "The O-O bond order in $O_2^{2-}$ species is", opts: ["0.5", "1.0", "1.5", "2.0"], correct: 1 },
            { id: "P8", sec: "XL-P", type: "MCQ", marks: 2, q: "Match the plots (P, Q, R) with reaction orders (Zero, First, Second). P: ln(x0/x) vs t; Q: (x0-x)/x vs t; R: x vs t.", opts: ["(P)-(1), (Q)-(2), (R)-(3)", "(P)-(3), (Q)-(2), (R)-(1)", "(P)-(2), (Q)-(3), (R)-(1)", "(P)-(2), (Q)-(1), (R)-(3)"], correct: 2 },
            { id: "P9", sec: "XL-P", type: "MCQ", marks: 2, q: "Structure of major product S (Diol reaction with MeOH, H+).", opts: ["Acetal formation A", "Acetal formation B", "Ether formation C", "Ether formation D"], correct: 0 },
            { id: "P10", sec: "XL-P", type: "MSQ", marks: 2, q: "Correct combination of Y and T for the elimination reaction (Hofmann vs Zaitsev).", opts: ["Y=NMe3, T=Hofmann product", "Y=NMe3, T=Zaitsev product", "Y=Br, T=Hofmann product", "Y=Br, T=Zaitsev product"], correct: [0, 3] },
            { id: "P11", sec: "XL-P", type: "MSQ", marks: 2, q: "Among the following, the diamagnetic species is(are):", opts: ["[CoF6]3-", "[Ni(H2O)6]2+", "[Fe(CN)6]4-", "[Co(NH3)6]3+"], correct: [2, 3] },
            { id: "P12", sec: "XL-P", type: "NAT", marks: 2, q: "Given heats of formation, average bond enthalpy of P-H bond in PH3(g) is ___ kJ/mol.", correct: [320, 325] },
            { id: "P13", sec: "XL-P", type: "NAT", marks: 2, q: "Total number of possible geometrical isomer(s) for $[PtBrCl(NH_3)(py)]^0$ is", correct: [3, 3] },
            { id: "P14", sec: "XL-P", type: "NAT", marks: 2, q: "Potential of the cell: Ag+(1mM) + Mg(s) <-> Ag(s) + Mg2+(0.2M) at 25C is ___ V.", correct: [2.90, 3.10] },
            { id: "P15", sec: "XL-P", type: "NAT", marks: 2, q: "Freezing point of 80g acetic acid lowered by 7.8 K by 20g compound. Molar mass of compound?", correct: [250, 250] },

            // === XL-S: MICROBIOLOGY ===
            { id: "S1", sec: "XL-S", type: "MCQ", marks: 1, q: "Antonie van Leeuwenhoek described organisms as:", opts: ["Bacteria", "Fungi", "Animalcules", "Bacteriophages"], correct: 2 },
            { id: "S2", sec: "XL-S", type: "MCQ", marks: 1, q: "Pathway oxidizing glucose to 2 pyruvic acid + 1 ATP + 1 NADH + 1 NADPH (Pseudomonas vs Bacillus):", opts: ["Gluconeogenesis", "EMP", "Entner-Doudoroff (ED)", "PPP"], correct: 2 },
            { id: "S3", sec: "XL-S", type: "MCQ", marks: 1, q: "Water balance in extreme halophiles (Halobacterium) maintained by surface glycoproteins of:", opts: ["glycine and lysine", "lysine and histidine", "glycine", "aspartate and glutamate"], correct: 3 },
            { id: "S4", sec: "XL-S", type: "MCQ", marks: 1, q: "Nocardia spp. not amenable to Gram staining due to:", opts: ["N-acetyltalosaminuronic acid", "thick peptidoglycan", "mycolic acid", "keto-deoxy-octulosonic acid"], correct: 2 },
            { id: "S5", sec: "XL-S", type: "MCQ", marks: 1, q: "Trichonympha in termite gut helps use wood. This is:", opts: ["parasitism", "competition", "commensalism", "mutualism"], correct: 3 },
            { id: "S6", sec: "XL-S", type: "MSQ", marks: 1, q: "Electron donor/s for CO2 reduction in purple sulfur bacteria:", opts: ["Hydrogen sulfide", "Thiosulfates", "Methane", "Sulfates"], correct: [0, 1] },
            { id: "S7", sec: "XL-S", type: "MSQ", marks: 1, q: "Catalyze(s) substrate-level phosphorylation:", opts: ["ATP synthase", "Succinate thiokinase", "Phosphofructokinase", "Pyruvate kinase"], correct: [1, 3] },
            { id: "S8", sec: "XL-S", type: "MSQ", marks: 1, q: "Method(s) to identify bacterial species:", opts: ["FISH", "PCR followed by sequencing", "Gram staining", "Acid-fast staining"], correct: [0, 1] },
            { id: "S9", sec: "XL-S", type: "MSQ", marks: 1, q: "Event(s) contributing to induction of lac operon:", opts: ["Accumulation of allolactose", "Direct binding of cAMP to DNA", "Binding of cAMP to CAP", "Elimination of cAMP"], correct: [0, 2] },
            { id: "S10", sec: "XL-S", type: "NAT", marks: 1, q: "One mole of circular plasmid digested with enzyme having 5 sites. Moles of fragments released?", correct: [5, 5] },
            { id: "S11", sec: "XL-S", type: "MCQ", marks: 2, q: "Molar growth yield (Y_ATP) for (i) S. faecalis (22g) and (ii) Z. mobilis (8.6g) from 1 mole glucose:", opts: ["11 and 4.3", "22 and 4.3", "22 and 8.6", "11 and 8.6"], correct: 2 },
            { id: "S12", sec: "XL-S", type: "MCQ", marks: 2, q: "Order of abundance of quinones (UQ, MQ, DMQ) in E. coli growing anaerobically on fumarate:", opts: ["UQ > DMQ > MQ", "MQ > DMQ > UQ", "MQ = DMQ > UQ", "MQ > UQ > DMQ"], correct: 1 },
            { id: "S13", sec: "XL-S", type: "MCQ", marks: 2, q: "ATPs per NADH in E. coli via (i) NDH-1 + cyt bo or (ii) NDH-2 + cyt bd:", opts: ["2.00 and 3.67", "3.00 and 2.67", "2.70 and 0.67", "2.50 and 0.50"], correct: 3 }, 
            { id: "S14", sec: "XL-S", type: "MCQ", marks: 2, q: "Match Immunoglobulins: (i) IgE (ii) IgG (iii) IgM (iv) IgA with functions.", opts: ["(i)-(s), (ii)-(p), (iii)-(q), (iv)-(r)", "(i)-(p), (ii)-(t), (iii)-(q), (iv)-(r)", "(i)-(q), (ii)-(p), (iii)-(t), (iv)-(r)", "(i)-(r), (ii)-(p), (iii)-(t), (iv)-(s)"], correct: 0 },
            { id: "S15", sec: "XL-S", type: "MCQ", marks: 2, q: "qRT-PCR profiles for SARS-CoV-2 (X, Y, Z). Dotted line is threshold. Z crosses late, X/Y cross early.", opts: ["X and Y negative; Z positive", "X/Y positive, no difference", "X/Y positive; X highest load", "X/Y positive; Y highest load"], correct: 2 },
            { id: "S16", sec: "XL-S", type: "MCQ", marks: 2, q: "Hfr mapping. Recombinants X, Y, Z appearance time. Identify X, Y, Z.", opts: ["X is x+, Y is r+, Z is p+", "X is p+, Y is r+, Z is x+", "X is x+, Y is p+, Z is r+", "X is p+, Y is x+, Z is r+"], correct: 0 },
            { id: "S17", sec: "XL-S", type: "NAT", marks: 2, q: "10 different surface antigens, ON/OFF randomly. Number of possible combinations?", correct: [1024, 1024] },
            { id: "S18", sec: "XL-S", type: "NAT", marks: 2, q: "mRNAs with only 2 nucleotides. Nucleotides per codon to encode at least 20 amino acids?", correct: [5, 5] },
            { id: "S19", sec: "XL-S", type: "NAT", marks: 2, q: "D value at 111 C for reducing 10^12 spores to 1 spore. (Z=10, D_121=0.2).", correct: [24, 24] }, 
            { id: "S20", sec: "XL-S", type: "NAT", marks: 2, q: "Generation time 30 min. Initial number to reach 10^9 in 2 hours?", correct: [6.25, 6.25] },

            // === XE-G: FOOD TECH ===
            { id: "G1", sec: "XE-G", type: "MCQ", marks: 1, q: "In typical bacterial growth curve, first order kinetics is observed in:", opts: ["Lag phase", "Log phase", "Stationary phase", "Death phase"], correct: 1 },
            { id: "G2", sec: "XE-G", type: "MCQ", marks: 1, q: "Which microorganism is NOT a causative agent for food borne diseases?", opts: ["Campylobacter jejuni", "Clostridium perfringens", "Norovirus", "Borrelia burgdorferi"], correct: 3 },
            { id: "G3", sec: "XE-G", type: "MCQ", marks: 1, q: "Which is NOT a fermented food?", opts: ["Tofu", "Vinegar", "Sauerkraut", "Tempeh"], correct: 0 },
            { id: "G4", sec: "XE-G", type: "MCQ", marks: 1, q: "Protein Efficiency Ratio (PER) is defined as:", opts: ["% absorbed N retained", "Weight gain per gram protein intake", "Ratio essential/non-essential AA", "% in vitro digestibility"], correct: 1 },
            { id: "G6", sec: "XE-G", type: "MCQ", marks: 1, q: "Enzyme involved in proteolysis of casein in cheese during aging?", opts: ["Myrosinase", "Alliinases", "Cathepsin", "Plasmin"], correct: 3 },
            { id: "G7", sec: "XE-G", type: "MCQ", marks: 1, q: "Which enzyme sequentially releases maltose from starch?", opts: ["Alpha-Amylase", "Beta-Amylase", "Glucoamylase", "Pullulanase"], correct: 1 },
            { id: "G8", sec: "XE-G", type: "MCQ", marks: 1, q: "UHT pasteurization of milk is achieved by heating at:", opts: ["145 F for 30 min", "161 F for 15 sec", "280 F for 2 sec", "400 F for 15 sec"], correct: 2 },
            { id: "G9", sec: "XE-G", type: "MCQ", marks: 1, q: "Bittering agent in grapefruit formed after juice extraction under acidic conditions:", opts: ["Quinine", "Theobromine", "Isohumulone", "Limonin"], correct: 3 },
            { id: "G10", sec: "XE-G", type: "MCQ", marks: 2, q: "Conversion of pyruvate to lactic acid in homolactic fermentation is catalyzed by:", opts: ["Lactate dehydrogenase", "Pyruvate dehydrogenase", "Lactase", "Pyruvate decarboxylase"], correct: 0 },
            { id: "G11", sec: "XE-G", type: "MCQ", marks: 2, q: "Which statement is INCORRECT regarding CAP/MAP?", opts: ["Limit microbial/biochemical activities", "Gas composition in MAP is continuously monitored/regulated", "CAP implies greater precision than MAP", "MAP relies on product respiration and film permeation"], correct: 1 },
            { id: "G12", sec: "XE-G", type: "MCQ", marks: 2, q: "Match Unit Operation: P. Hydrogenation (1. Wax removal), Q. Blanching (2. Fat shortening), R. Leaching (3. Enzyme inactivation), S. Winterization (4. Dye separation).", opts: ["P-2, Q-4, R-2, S-1", "P-2, Q-3, R-4, S-1", "P-4, Q-1, R-2, S-3", "P-4, Q-2, R-1, S-3"], correct: 1 },
            { id: "G13", sec: "XE-G", type: "MSQ", marks: 2, q: "Correct pair of GRAS preservative, organism, and food matrix:", opts: ["Sodium lactate-Bacteria-Meats", "Caprylic acid-Insects-Cheese wraps", "Dehydroacetic acid-Molds-Squash", "Sodium nitrite-Clostridia-Meat curing"], correct: [0, 2, 3] },
            { id: "G14", sec: "XE-G", type: "MSQ", marks: 2, q: "Correct pair of pigment and color:", opts: ["Carotene - Yellow/orange", "Betanin - Purple/red", "Lycopene - Red", "Flavanols - Orange"], correct: [0, 1, 2] },
            { id: "G15", sec: "XE-G", type: "MSQ", marks: 2, q: "Anti-nutritional factors:", opts: ["Phytate", "Isoflavones", "Trypsin Inhibitor", "Resveratrol"], correct: [0, 2] },
            { id: "G16", sec: "XE-G", type: "MSQ", marks: 2, q: "Media in supercritical fluid extraction:", opts: ["Water", "Carbon dioxide", "Dichloromethane", "Carbon dioxide with Ethanol"], correct: [1, 3] },
            { id: "G17", sec: "XE-G", type: "MSQ", marks: 2, q: "Expressions representing Reynolds number:", opts: ["Density-Velocity-Diameter / Dynamic Viscosity", "Velocity-Diameter / Kinematic Viscosity", "Dynamic Viscosity / Velocity-Density-Diameter", "Kinematic Viscosity / Velocity-Diameter"], correct: [0, 1] },
            { id: "G18", sec: "XE-G", type: "MSQ", marks: 2, q: "Correct combinations of Equipment - Property - Food Property:", opts: ["Particle size analyzer - size - span", "Texture profile analyzer - morphology - chewiness", "DSC - Tg - caking", "Capillary viscometer - viscosity - sensory"], correct: [0, 2] },
            { id: "G19", sec: "XE-G", type: "MSQ", marks: 2, q: "Correct Governing Law and Application:", opts: ["Hagen Poiseuille - Pressure drop", "Rittinger - Vapour pressure", "Stefan Boltzmann - Radiation", "Raoult - Size reduction"], correct: [0, 2] },
            { id: "G20", sec: "XE-G", type: "NAT", marks: 2, q: "Evaporator: 10% to 40% solids, 3600 kg/hr feed. Heat transfer rate in kW?", correct: [1900, 1910] },
            { id: "G21", sec: "XE-G", type: "NAT", marks: 2, q: "Tray dryer humidity calculation.", correct: [0.14, 0.15] },
            { id: "G22", sec: "XE-G", type: "NAT", marks: 2, q: "Cold storage potato respiration load (ton of refrigeration).", correct: [2.25, 2.35] }
        ];

        let responses = {};
        let currentSec = 'XL-P';
        let currentIdx = 0;
        let visited = new Set();
        let questions = [];

        function init() {
            // Get user from local storage or set guest
            const user = localStorage.getItem("REC_USER_ID") || "GUEST";
            document.getElementById("user-id-disp").innerText = user;

            switchSection('XL-P');
            
            setInterval(() => {
                let t = document.getElementById('timer');
                let [m, s] = t.innerText.split(':').map(Number);
                if (s === 0) { if (m === 0) return; m--; s = 59; } else s--;
                t.innerText = `${m}:${s < 10 ? '0' + s : s}`;
            }, 1000);
        }

        function switchSection(sec) {
            currentSec = sec;
            questions = db.filter(q => q.sec === sec);
            currentIdx = 0;
            document.querySelectorAll('.tab').forEach(t => {
                t.className = t.innerText.includes(sec) ? 'tab active' : 'tab';
            });
            renderPalette();
            loadQ(0);
        }

        function loadQ(idx) {
            currentIdx = idx;
            let q = questions[idx];
            visited.add(q.id);
            
            document.getElementById('disp-num').innerText = idx + 1;
            document.getElementById('disp-qid').innerText = q.id;
            document.getElementById('disp-type').innerText = q.type;
            document.getElementById('disp-marks').innerText = `+${q.marks} Mark${q.marks > 1 ? 's' : ''}`;
            document.getElementById('disp-text').innerHTML = q.q;

            let optsDiv = document.getElementById('disp-options');
            optsDiv.innerHTML = '';

            let saved = responses[q.id];

            if (q.type === 'MCQ') {
                q.opts.forEach((opt, i) => {
                    let checked = saved === i ? 'checked' : '';
                    optsDiv.innerHTML += `<label class="option-label"><input type="radio" name="ans" value="${i}" onclick="save(${i})" ${checked}> ${opt}</label>`;
                });
            } else if (q.type === 'MSQ') {
                q.opts.forEach((opt, i) => {
                    let checked = (saved || []).includes(i) ? 'checked' : '';
                    optsDiv.innerHTML += `<label class="option-label"><input type="checkbox" value="${i}" onclick="saveMSQ(this, ${i})" ${checked}> ${opt}</label>`;
                });
            } else if (q.type === 'NAT') {
                optsDiv.innerHTML = `<input type="number" class="nat-input" onblur="saveNAT(this)" value="${saved || ''}" placeholder="Enter Answer">`;
            }
            
            if(window.MathJax) MathJax.typeset();
            renderPalette();
        }

        function save(val) { responses[questions[currentIdx].id] = val; renderPalette(); }
        
        function saveMSQ(el, val) {
            let id = questions[currentIdx].id;
            let arr = responses[id] || [];
            if (el.checked) arr.push(val); else arr = arr.filter(x => x !== val);
            responses[id] = arr;
            renderPalette();
        }
        
        function saveNAT(el) { 
            let val = parseFloat(el.value);
            if (!isNaN(val)) responses[questions[currentIdx].id] = val; 
            renderPalette();
        }

        function renderPalette() {
            let p = document.getElementById('palette');
            p.innerHTML = '';
            questions.forEach((q, i) => {
                let cls = 'p-btn';
                if (i === currentIdx) cls += ' active';
                if (responses[q.id] !== undefined) cls += ' answered';
                else if (visited.has(q.id)) cls += ' visited';
                p.innerHTML += `<div class="${cls}" onclick="loadQ(${i})">${i + 1}</div>`;
            });
        }

        function nav(dir) {
            let next = currentIdx + dir;
            if (next >= 0 && next < questions.length) loadQ(next);
        }

        // ==========================================
        // --- SCORE & UPLOAD LOGIC ---
        // ==========================================
        async function submitExam() {
            if (!confirm("Are you sure you want to submit? This will upload your data.")) return;

            document.getElementById('loadingModal').style.display = 'flex';

            let totalScore = 0;
            let sectionScores = { "XL-P": 0, "XL-S": 0, "XE-G": 0 };
            
            db.forEach(q => {
                let ans = responses[q.id];
                let points = 0;
                
                if (ans !== undefined) {
                    if (q.type === 'MCQ' && ans === q.correct) points = q.marks;
                    else if (q.type === 'MSQ' && JSON.stringify(ans.sort()) === JSON.stringify(q.correct.sort())) points = q.marks;
                    else if (q.type === 'NAT' && ans >= q.correct[0] && ans <= q.correct[1]) points = q.marks;
                    
                    // Negative marking for MCQs (Optional - uncomment to enable)
                    // else if (q.type === 'MCQ') points = -(q.marks / 3);
                }

                if (points > 0) {
                    totalScore += points;
                    if (sectionScores[q.sec] !== undefined) sectionScores[q.sec] += points;
                }
            });

            // Update UI
            document.getElementById('final-total').innerText = totalScore.toFixed(2);
            document.getElementById('score-p').innerText = sectionScores["XL-P"].toFixed(2);
            document.getElementById('score-s').innerText = sectionScores["XL-S"].toFixed(2);
            document.getElementById('score-g').innerText = sectionScores["XE-G"].toFixed(2);

            // Upload to Firebase
            const payload = {
                student_id: localStorage.getItem("REC_USER_ID") || "GUEST",
                exam_name: "GATE_2021_XL",
                total_score: totalScore,
                section_scores: sectionScores,
                timestamp: new Date().toISOString(),
                responses: JSON.stringify(responses)
            };

            if (dbRef) {
                try {
                    await addDoc(collection(dbRef, "exam_results"), payload);
                    console.log("Uploaded successfully");
                } catch (e) {
                    console.error("Upload failed", e);
                    alert("Submission calculated locally but Upload failed. Check console config.");
                }
            } else {
                console.warn("Firebase not configured. Running in Local Mode.");
            }

            document.getElementById('loadingModal').style.display = 'none';
            document.getElementById('resultModal').style.display = 'flex';
        }

        init();
    </script>
</body>
</html>

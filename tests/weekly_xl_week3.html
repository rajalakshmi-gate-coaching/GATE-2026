<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE 2021 Exam Server (XL-P, XL-S, XE-G)</title>
    <style>
        :root { --primary: #003366; --light: #f8f9fa; --dark: #343a40; --correct: #28a745; --wrong: #dc3545; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f4f7f6; }
        
        /* Header */
        header { background-color: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .timer { font-weight: bold; font-size: 1.2rem; background: #FFCC00; padding: 5px 15px; border-radius: 4px; color: black; }
        
        /* Tabs */
        .tabs { display: flex; background: #e9ecef; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #e9ecef; cursor: pointer; font-weight: bold; font-size: 1rem; color: #555; transition: 0.3s; }
        .tab-btn:hover { background: #dde2e6; }
        .tab-btn.active { background: white; color: var(--primary); border-top: 4px solid var(--primary); border-bottom: 1px solid white; }

        /* Main Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* Question Area */
        .main-content { flex: 3; padding: 30px; overflow-y: auto; background: white; display: flex; flex-direction: column; }
        .q-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .q-badge { background: #ddd; color: black; padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; margin-right: 10px; font-weight: bold; }
        .q-text { font-size: 1.2rem; line-height: 1.6; margin-bottom: 25px; white-space: pre-wrap; }
        
        /* Options */
        .option-container { display: flex; flex-direction: column; gap: 10px; }
        .option-label { display: flex; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: 0.2s; background: #f8f9fa; }
        .option-label:hover { background-color: #e2e6ea; border-color: var(--primary); }
        .option-label input { margin-right: 15px; transform: scale(1.2); }
        .nat-input { padding: 10px; font-size: 1.2rem; border: 2px solid var(--primary); border-radius: 4px; width: 250px; }

        /* Sidebar (Palette) */
        .sidebar { flex: 1; background: #e9ecef; border-left: 1px solid #ccc; display: flex; flex-direction: column; max-width: 350px; }
        .user-panel { padding: 15px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
        .legend { padding: 10px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: white; border-bottom: 1px solid #ddd; }
        .legend span { display: inline-block; width: 15px; height: 15px; margin-right: 8px; border-radius: 3px; border: 1px solid #ccc; }
        .palette { flex: 1; padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-content: start; }
        .p-btn { padding: 10px 0; background: white; border: 1px solid #ccc; cursor: pointer; text-align: center; border-radius: 4px; font-weight: bold; }
        
        /* Palette Colors */
        .p-btn.active { border: 2px solid var(--primary); transform: scale(1.05); }
        .p-btn.answered { background-color: #28a745; color: white; border-color: #28a745; }
        .p-btn.review { background-color: #007bff; color: white; border-color: #007bff; }
        .p-btn.review-ans { background-color: #6610f2; color: white; border-color: #6610f2; }
        .p-btn.visited { background-color: #dc3545; color: white; border-color: #dc3545; }

        /* Footer */
        .footer { padding: 15px 30px; background: white; border-top: 1px solid #ccc; display: flex; justify-content: space-between; }
        .btn { padding: 10px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-prev { background: #6c757d; }
        .btn-save { background: #28a745; }
        .btn-review { background: #ffc107; color: black; }
        .btn-submit { background: var(--primary); width: 100%; }
        .btn:hover { opacity: 0.9; }

        /* Results Modal */
        #resultModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; width: 90%; max-width: 800px; max-height: 90vh; padding: 20px; border-radius: 8px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
    
    <script type="module">
        // Import Firebase Logic
        import { db, collection, addDoc } from "../js/firebase_config.js";

        // Expose functions globally
        window.switchSubject = switchSubject;
        window.navQuestion = navQuestion;
        window.saveAndNext = saveAndNext;
        window.markForReview = markForReview;
        window.jumpTo = jumpTo;
        window.submitExam = submitExam; // Exposed for HTML button

        // --- EXAM DATA ---
        // Normalized property names: 'question' instead of 'q', 'correct' instead of 'ans'
        const examDb = {
            chem: [
                { id: 1, type: "MCQ", marks: 1, question: "The geometry of Fe(CO)5 is (Atomic number Fe=26)", options: ["Pentagonal planar", "Square pyramidal", "Trigonal bipyramidal", "Trigonal pyramidal"], correct: 2 },
                { id: 2, type: "MCQ", marks: 1, question: "Reaction of acetone derivative with Mg/dry Et2O followed by D2O leads to:", options: ["Deuterated alcohol", "Diol", "Mg-complex", "Alkane"], correct: 1 },
                { id: 3, type: "NAT", marks: 1, question: "Time taken by a first order reaction to reach 90% completion is 20 s. Time for 50% completion is ___ s. (Round off to integer)", correct: 6 },
                { id: 4, type: "NAT", marks: 1, question: "Ground state energy of H atom is -13.60 eV. Energy in third excited state is ___ eV. (2 decimal places)", correct: -0.85 },
                { id: 5, type: "NAT", marks: 1, question: "Absorbance 0.42, Path 1 cm, Epsilon 8400. Conc in 10^-5 M is ___.", correct: 5 },
                { id: 6, type: "MCQ", marks: 2, question: "Correct order of acidity (Structure based question).", options: ["II > I > III", "III > II > I", "I > II > III", "III > I > II"], correct: 0 },
                { id: 7, type: "MCQ", marks: 2, question: "The O-O bond order in O2(2-) species is", options: ["0.5", "1.0", "1.5", "2.0"], correct: 1 },
                { id: 8, type: "MCQ", marks: 2, question: "Match reaction order plots.", options: ["P-1, Q-2, R-3", "P-3, Q-2, R-1", "P-2, Q-3, R-1", "P-2, Q-1, R-3"], correct: 3 },
                { id: 9, type: "MCQ", marks: 2, question: "Structure of major product S (Diol + MeOH/H+ reaction).", options: ["Acetal", "Ether", "Ester", "Ketone"], correct: 0 },
                { id: 10, type: "MSQ", marks: 2, question: "Correct combination of Y and T for elimination reaction.", options: ["Y=NMe3+, T=Hoffman", "Y=NMe3+, T=Saytzeff", "Y=Br, T=Saytzeff", "Y=Br, T=Hoffman"], correct: [0, 2] },
                { id: 11, type: "MSQ", marks: 2, question: "Diamagnetic species among the following:", options: ["[CoF6]3-", "[Ni(H2O)6]2+", "[Fe(CN)6]4-", "[Co(NH3)6]3+"], correct: [2, 3] },
                { id: 12, type: "NAT", marks: 2, question: "Average bond enthalpy of P-H bond in PH3 (kJ/mol). (Round to 1 decimal)", correct: 321.1 },
                { id: 13, type: "NAT", marks: 2, question: "Total number of geometrical isomers for [PtBrCl(NH3)(py)].", correct: 3 },
                { id: 14, type: "NAT", marks: 2, question: "Potential of cell: Ag+(1mM) + Mg -> Ag + Mg2+(0.2M) at 25C. (V, 2 decimals)", correct: 3.01 },
                { id: 15, type: "NAT", marks: 2, question: "Molar mass of compound (Freezing point depression).", correct: 125 }
            ],
            micro: [
                { id: 1, type: "MCQ", marks: 1, question: "Antonie van Leeuwenhoek described microorganisms as:", options: ["Bacteria", "Fungi", "Animalcules", "Bacteriophages"], correct: 2 },
                { id: 2, type: "MCQ", marks: 1, question: "Pathway oxidizing glucose to 2 pyruvate, 1 ATP, 1 NADH, 1 NADPH in Pseudomonas but not Bacillus:", options: ["Gluconeogenesis", "EMP", "Entner-Doudoroff (ED)", "PPP"], correct: 2 },
                { id: 3, type: "MCQ", marks: 1, question: "Water balance in Halobacterium maintained by glycoproteins rich in:", options: ["Glycine/Lysine", "Lysine/Histidine", "Glycine", "Aspartate/Glutamate"], correct: 3 },
                { id: 4, type: "MCQ", marks: 1, question: "Nocardia not amenable to Gram stain due to:", options: ["N-acetyltalosaminuronic acid", "Thick peptidoglycan", "Mycolic acid", "KDO"], correct: 2 },
                { id: 5, type: "MCQ", marks: 1, question: "Trichonympha in termite gut is an example of:", options: ["Parasitism", "Competition", "Commensalism", "Mutualism"], correct: 3 },
                { id: 6, type: "MSQ", marks: 1, question: "Electron donors for CO2 reduction in purple sulfur bacteria:", options: ["Hydrogen sulfide", "Thiosulfates", "Methane", "Sulfates"], correct: [0, 1] },
                { id: 7, type: "MSQ", marks: 1, question: "Enzymes catalyzing substrate-level phosphorylation:", options: ["ATP synthase", "Succinate thiokinase", "Phosphofructokinase", "Pyruvate kinase"], correct: [1, 3] },
                { id: 8, type: "MSQ", marks: 1, question: "Methods to identify bacterial species:", options: ["FISH", "PCR + Sequencing", "Gram staining", "Acid-fast staining"], correct: [0, 1] },
                { id: 9, type: "MSQ", marks: 1, question: "Events contributing to lac operon induction in wild-type E. coli:", options: ["Accumulation of allolactose", "Direct cAMP binding to DNA", "cAMP binding to CAP protein", "Elimination of cAMP"], correct: [0, 2] },
                { id: 10, type: "NAT", marks: 1, question: "Moles of fragments from 1 mole circular plasmid with 5 restriction sites.", correct: 5 },
                { id: 11, type: "MCQ", marks: 2, question: "Molar growth yield (Y_ATP) for S. faecalis and Z. mobilis.", options: ["11 and 4.3", "22 and 4.3", "22 and 8.6", "11 and 8.6"], correct: 3 },
                { id: 12, type: "MCQ", marks: 2, question: "Order of quinone abundance in anaerobic E. coli on fumarate.", options: ["UQ>DMQ>MQ", "MQ>DMQ>UQ", "MQ=DMQ>UQ", "MQ>UQ>DMQ"], correct: 1 },
                { id: 13, type: "MCQ", marks: 2, question: "ATPs per NADH via (i) NDH-1/Cyt bo (ii) NDH-2/Cyt bd.", options: ["2.00, 3.67", "3.00, 2.67", "2.70, 0.67", "2.50, 0.50"], correct: 2 },
                { id: 14, type: "MCQ", marks: 2, question: "Match Immunoglobulins: IgE, IgG, IgM, IgA.", options: ["i-s, ii-p, iii-q, iv-r", "i-p, ii-t, iii-q, iv-r", "i-q, ii-p, iii-t, iv-r", "i-r, ii-p, iii-t, iv-s"], correct: 0 },
                { id: 15, type: "MCQ", marks: 2, question: "qRT-PCR Profile interpretation.", options: ["X,Y neg", "X,Y pos no diff", "X,Y pos, X highest load", "X,Y pos, Y highest load"], correct: 2 },
                { id: 16, type: "MCQ", marks: 2, question: "Hfr Mapping: Order X, Y, Z appearance.", options: ["X=x, Y=r, Z=p", "X=p, Y=r, Z=x", "X=x, Y=p, Z=r", "X=p, Y=x, Z=r"], correct: 1 },
                { id: 17, type: "NAT", marks: 2, question: "10 antigens, ON/OFF randomly. Number of combinations.", correct: 1024 },
                { id: 18, type: "NAT", marks: 2, question: "2 nucleotides, 20 amino acids. Nucleotides per codon?", correct: 5 },
                { id: 19, type: "NAT", marks: 2, question: "D-value at 111C (12 log reduction). D121=0.2, Z=10.", correct: 24 },
                { id: 20, type: "NAT", marks: 2, question: "Initial bacteria for 10^9 in 2h (gen time 30 min). Answer * 10^7.", correct: 6.25 }
            ],
            food: [
                { id: 1, type: "MCQ", marks: 1, question: "First order kinetics for growth rate is observed in:", options: ["Lag phase", "Log phase", "Stationary phase", "Death phase"], correct: 1 },
                { id: 2, type: "MCQ", marks: 1, question: "NOT a causative agent for food borne diseases:", options: ["Campylobacter jejuni", "Clostridium perfringens", "Norovirus", "Borrelia burgdorferi"], correct: 3 },
                { id: 3, type: "MCQ", marks: 1, question: "NOT a fermented food product:", options: ["Tofu", "Vinegar", "Sauerkraut", "Tempeh"], correct: 0 },
                { id: 4, type: "MCQ", marks: 1, question: "Protein Efficiency Ratio (PER) definition:", options: ["% Absorbed Nitrogen", "Weight gain per gram protein intake", "Ratio essential/non-essential", "Percent digestibility"], correct: 1 },
                { id: 5, type: "MCQ", marks: 1, question: "Placeholder Question.", options: ["Option A", "Option B", "Option C", "Option D"], correct: 0 },
                { id: 6, type: "MCQ", marks: 1, question: "Enzyme involved in proteolysis of casein in cheese aging:", options: ["Myrosinase", "Alliinases", "Cathepsin", "Plasmin"], correct: 3 },
                { id: 7, type: "MCQ", marks: 1, question: "Enzyme releasing maltose from starch sequentially:", options: ["Alpha-Amylase", "Beta-Amylase", "Glucoamylase", "Pullulanase"], correct: 1 },
                { id: 8, type: "MCQ", marks: 1, question: "UHT pasteurization conditions:", options: ["145F, 30 min", "161F, 15 s", "280F (138C), 2 s", "400F, 15 s"], correct: 2 },
                { id: 9, type: "MCQ", marks: 1, question: "Bittering agent in grape fruit juice (acidic):", options: ["Quinine", "Theobromine", "Isohumulone", "Limonin"], correct: 3 },
                { id: 10, type: "MCQ", marks: 2, question: "Pyruvate to lactic acid enzyme:", options: ["Lactate dehydrogenase", "Pyruvate dehydrogenase", "Lactase", "Pyruvate decarboxylase"], correct: 0 },
                { id: 11, type: "MCQ", marks: 2, question: "Incorrect statement about CAP/MAP:", options: ["Both limit microbial activity", "MAP gas is continuously regulated", "CAP has higher precision", "MAP modifies atmosphere naturally/passively"], correct: 1 },
                { id: 12, type: "MCQ", marks: 2, question: "Match Unit Ops: P-Hydrogenation, Q-Blanching, R-Leaching, S-Winterization.", options: ["P-2, Q-4, R-2, S-1", "P-2, Q-3, R-4, S-1", "P-4, Q-1, R-2, S-3", "P-4, Q-2, R-1, S-3"], correct: 1 },
                { id: 13, type: "MSQ", marks: 2, question: "Correct pairs of GRAS preservative/organism/food:", options: ["Na-Lactate/Bacteria/Meat", "Caprylic/Insects/Cheese", "Dehydroacetic/Molds/Squash", "Na-Nitrite/Clostridia/Meat"], correct: [0, 3] },
                { id: 14, type: "MSQ", marks: 2, question: "Correct Pigment/Color/Source:", options: ["Carotene/Yellow-Orange/Peppers", "Betanin/Purple-Red/Cactus Pear", "Lycopene/Red/Beets", "Flavanols/Orange/Cauliflower"], correct: [0, 1] },
                { id: 15, type: "MSQ", marks: 2, question: "Anti-nutritional factors:", options: ["Phytate", "Isoflavones", "Trypsin Inhibitor", "Resveratrol"], correct: [0, 2] },
                { id: 16, type: "MSQ", marks: 2, question: "Media for supercritical fluid extraction:", options: ["Water", "Carbon dioxide", "Dichloromethane", "CO2 with Ethanol"], correct: [1, 3] },
                { id: 17, type: "MCQ", marks: 2, question: "Reynolds Number Expression:", options: ["(rho*v*D)/mu", "(v*D)/nu", "mu/(v*rho*D)", "nu/(v*D)"], correct: 0 },
                { id: 18, type: "MCQ", marks: 2, question: "Correct combinations of Equipment/Property:", options: ["Particle size/span value", "Texture profile/Chewiness", "DSC/Glass transition", "Capillary/Sensory"], correct: 1 }, 
                { id: 19, type: "MCQ", marks: 2, question: "Correct pair of Law/Application:", options: ["Hagen Poiseuille/Pressure drop", "Rittinger/Vapour", "Stefan Boltzmann/Radiation", "Raoult/Size reduction"], correct: 2 }, 
                { id: 20, type: "NAT", marks: 2, question: "Evaporator Heat Transfer Rate (kW integer). Feed 3600kg/h 10% to 40%. Cp=4.0. T=55C. Enthalpy=2600.", correct: 2070 },
                { id: 21, type: "NAT", marks: 2, question: "Humidity of air leaving dryer (kg/kg). RH=60%, P=101.35, Psat=31.2.", correct: 0.141 },
                { id: 22, type: "NAT", marks: 2, question: "Refrigeration Capacity (Tons). 5000kg Potato. 28C to 2C in 24h. Resp=3.12 kJ/kg/day. Eff=70%.", correct: 2.30 }
            ]
        };

        // --- GLOBAL VARIABLES ---
        let currentSubject = 'chem';
        let userResponses = { chem: {}, micro: {}, food: {} };
        let currentQIndex = 0;
        let timerInterval;
        let timeRemaining = 180 * 60; // 3 hours

        // --- INITIALIZATION ---
        window.onload = function() {
            startTimer();
            switchSubject('chem'); // Initialize first subject
        };

        // --- CORE FUNCTIONS ---
        
        function switchSubject(sub) {
            currentSubject = sub;
            currentQIndex = 0;
            
            // Update UI Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Find button with matching onclick attribute (simple way without IDs)
            const buttons = document.querySelectorAll('.tab-btn');
            if(sub === 'chem') buttons[0].classList.add('active');
            if(sub === 'micro') buttons[1].classList.add('active');
            if(sub === 'food') buttons[2].classList.add('active');

            // Update Subject Title in Sidebar
            const titles = { chem: "Chemistry Palette", micro: "Microbiology Palette", food: "Food Tech Palette" };
            document.getElementById('subject-title').innerText = titles[sub];

            loadPalette();
            loadQuestion(0);
        }

        function loadQuestion(index) {
            currentQIndex = index;
            const q = examDb[currentSubject][index];
            const savedAns = userResponses[currentSubject][q.id];

            let html = `
                <div class="q-header">
                    <div><span class="q-badge">Q${index + 1}</span> <span class="q-badge">${q.type}</span></div>
                    <div style="color: green; font-weight: bold;">+${q.marks} Marks</div>
                </div>
                <div class="q-text">${q.question}</div>
                <div class="option-container">
            `;

            if (q.type === 'MCQ') {
                q.options.forEach((opt, i) => {
                    const isChecked = savedAns === i ? 'checked' : '';
                    html += `
                        <label class="option-label">
                            <input type="radio" name="ans" value="${i}" ${isChecked}>
                            ${opt}
                        </label>`;
                });
            } else if (q.type === 'MSQ') {
                q.options.forEach((opt, i) => {
                    const isChecked = (savedAns && savedAns.includes(i)) ? 'checked' : '';
                    html += `
                        <label class="option-label">
                            <input type="checkbox" name="ans" value="${i}" ${isChecked}>
                            ${opt}
                        </label>`;
                });
            } else if (q.type === 'NAT') {
                const val = savedAns !== undefined ? savedAns : '';
                html += `<input type="number" class="nat-input" id="nat-input" value="${val}" placeholder="Enter numerical value">`;
            }

            html += `</div>`;
            document.getElementById('question-panel').innerHTML = html;
            updatePalette();
        }

        function loadPalette() {
            const grid = document.getElementById('palette-grid');
            grid.innerHTML = '';
            examDb[currentSubject].forEach((q, i) => {
                const ans = userResponses[currentSubject][q.id];
                let className = 'p-btn';
                
                // Active Question Border
                if (i === currentQIndex) className += ' active'; 
                
                // Answered Green
                if (ans !== undefined && ans !== null && ans !== "" && (!Array.isArray(ans) || ans.length > 0)) {
                    className += ' answered'; 
                } 
                // Visited Logic (Simplified: if not current and not answered, treat as visited/skipped for now. 
                // Real logic usually tracks 'visited' state separately. Here we simplify.)
                else if (i !== currentQIndex) {
                     // className += ' visited'; // Uncomment if you want red for all non-answered non-active
                }
                
                const btn = document.createElement('div');
                btn.className = className;
                btn.innerText = i + 1;
                btn.onclick = () => loadQuestion(i);
                grid.appendChild(btn);
            });
        }

        function navQuestion(step) {
            const newIndex = currentQIndex + step;
            const total = examDb[currentSubject].length;
            if (newIndex >= 0 && newIndex < total) {
                loadQuestion(newIndex);
            }
        }

        function saveAndNext() {
            const q = examDb[currentSubject][currentQIndex];
            let answer = null;

            if (q.type === 'MCQ') {
                const sel = document.querySelector('input[name="ans"]:checked');
                if (sel) answer = parseInt(sel.value);
            } else if (q.type === 'MSQ') {
                const sels = document.querySelectorAll('input[name="ans"]:checked');
                if (sels.length > 0) answer = Array.from(sels).map(el => parseInt(el.value));
            } else if (q.type === 'NAT') {
                const el = document.getElementById('nat-input');
                if (el && el.value !== "") answer = parseFloat(el.value);
            }

            if (answer !== null) {
                userResponses[currentSubject][q.id] = answer;
            } else {
                delete userResponses[currentSubject][q.id];
            }

            if (currentQIndex < examDb[currentSubject].length - 1) {
                loadQuestion(currentQIndex + 1);
            } else {
                loadPalette();
            }
        }

        function markForReview() {
            // Placeholder logic. Real app would toggle a 'review' flag.
            saveAndNext(); 
        }

        function jumpTo(i) {
            loadQuestion(i);
        }

        // --- SUBMISSION Logic ---
        function submitExam(autoSubmit = false) {
            clearInterval(timerInterval);
            let totalScore = 0;
            let attempted = 0;
            let maxMarks = 0;
            let htmlResults = "";

            // Cloud Upload Logic (simulated)
            const analysisData = [];

            ['chem', 'micro', 'food'].forEach(sub => {
                let subScore = 0;
                let subMax = 0;
                htmlResults += `<h3 style="margin-top:20px; border-bottom:1px solid #ccc;">${sub.toUpperCase()} SECTION</h3><ul style="list-style:none; padding:0;">`;
                
                examDb[sub].forEach(q => {
                    subMax += q.marks;
                    const userAns = userResponses[sub][q.id];
                    const isAttempted = userAns !== undefined && userAns !== null && userAns !== "" && (!Array.isArray(userAns) || userAns.length > 0);
                    
                    if (isAttempted) attempted++;

                    let isCorrect = false;
                    
                    if (isAttempted) {
                        if (q.type === 'MCQ') {
                            isCorrect = (userAns === q.correct);
                        } else if (q.type === 'MSQ') {
                            const u = userAns.sort().toString();
                            const c = q.correct.sort().toString();
                            isCorrect = (u === c);
                        } else if (q.type === 'NAT') {
                            isCorrect = Math.abs(userAns - q.correct) < 0.1; 
                        }
                    }

                    // Score Calculation
                    if (isCorrect) {
                        subScore += q.marks;
                        htmlResults += `<li style="color:green; padding:5px 0;">Q${q.id}: Correct (+${q.marks})</li>`;
                    } else if (isAttempted && !isCorrect) {
                        // Negative marking for MCQ only
                        if (q.type === 'MCQ') {
                            const deduction = q.marks === 1 ? 1/3 : 2/3;
                            subScore -= deduction;
                            htmlResults += `<li style="color:red; padding:5px 0;">Q${q.id}: Wrong (-${deduction.toFixed(2)})</li>`;
                        } else {
                            htmlResults += `<li style="color:orange; padding:5px 0;">Q${q.id}: Wrong (0)</li>`;
                        }
                    } else {
                        htmlResults += `<li style="color:gray; padding:5px 0;">Q${q.id}: Unattempted</li>`;
                    }

                    // Prepare Cloud Data Object
                    analysisData.push({
                        subject: sub,
                        id: q.id,
                        type: q.type,
                        question: q.question,
                        user_ans: userAns,
                        correct_ans: q.correct,
                        status: isCorrect ? "Correct" : (isAttempted ? "Wrong" : "Unattempted")
                    });
                });
                totalScore += subScore;
                maxMarks += subMax;
            });

            // Upload to Cloud Firestore (Mock call)
            uploadToCloud(totalScore, attempted, analysisData);

            // Show Result Modal
            document.getElementById('score-total').innerText = totalScore.toFixed(2);
            document.getElementById('attempted-total').innerText = attempted;
            document.getElementById('accuracy-total').innerText = attempted ? ((totalScore/maxMarks)*100).toFixed(1) + "%" : "0%";
            document.getElementById('detailed-results').innerHTML = htmlResults;
            document.getElementById('resultModal').style.display = "flex";
        }

        async function uploadToCloud(score, attempted, analysis) {
            try {
                // Since this is inside the module, we use the imported db object
                await addDoc(collection(db, "student_responses"), {
                    student_id: localStorage.getItem("REC_USER_ID") || "GUEST",
                    exam_name: "GATE2021_XL_Mock",
                    score: score,
                    attempted: attempted,
                    date: new Date().toISOString(),
                    analysis: JSON.stringify(analysis)
                });
                console.log("Results uploaded to Firebase.");
            } catch (e) {
                console.error("Upload failed:", e);
            }
        }

        // --- TIMER ---
        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                const h = Math.floor(timeRemaining / 3600);
                const m = Math.floor((timeRemaining % 3600) / 60);
                const s = timeRemaining % 60;
                document.getElementById('timer').innerText = 
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if (timeRemaining <= 0) submitExam(true);
            }, 1000);
        }

    </script>
</body>
</html>

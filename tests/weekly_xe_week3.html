<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE 2021 (XE) - Official CBT Server</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #003366; --success: #28a745; --danger: #dc3545; --light: #f8f9fa; --dark: #343a40; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--light); color: #333; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .timer { font-family: 'Courier New', monospace; font-size: 1.4rem; font-weight: bold; color: #ffcc00; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 5px; }

        /* Navigation Tabs */
        .tabs { display: flex; background: white; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: 600; color: #6c757d; transition: 0.3s; border-bottom: 4px solid transparent; }
        .tab:hover { background: #f1f3f5; }
        .tab.active { color: var(--primary); border-bottom: 4px solid var(--primary); background: #eef4fb; }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* Question Area */
        .q-area { flex: 1; padding: 40px; overflow-y: auto; background: white; }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 15px; }
        .q-badge { background: #333; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; margin-right: 10px; }
        .q-text { font-size: 1.25rem; line-height: 1.6; margin-bottom: 30px; }
        
        /* Options */
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option-label { display: flex; align-items: center; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 1.05rem; }
        .option-label:hover { border-color: var(--primary); background: #f8fbff; }
        .option-label input { margin-right: 15px; transform: scale(1.3); }
        .nat-input { padding: 12px; font-size: 1.2rem; border: 2px solid var(--primary); border-radius: 6px; width: 250px; outline: none; }

        /* Sidebar */
        .sidebar { width: 320px; background: #fff; border-left: 1px solid #dee2e6; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
        .user-panel { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; text-align: center; }
        .palette { flex: 1; padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-content: start; }
        .p-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; background: white; }
        .p-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .p-btn.active { border: 2px solid var(--primary); color: var(--primary); }
        .p-btn.answered { background: var(--success); color: white; border-color: var(--success); }
        .p-btn.visited { background: var(--danger); color: white; border-color: var(--danger); }

        /* Footer */
        footer { padding: 15px 30px; background: white; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-prev { background: #6c757d; }
        .btn-next { background: var(--primary); }
        .btn-submit { background: var(--success); width: 100%; margin-top: 15px; padding: 15px; font-size: 1.1rem; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .score-box { background: #f1f3f5; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .score-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 1.1rem; }
    </style>
</head>
<body>

    <header>
        <div><strong>GATE 2021 (XE)</strong> | Engineering Sciences CBT</div>
        <div class="timer" id="timer">180:00</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchSection('XE-A')">XE-A: Mathematics</div>
        <div class="tab" onclick="switchSection('XE-C')">XE-C: Materials Science</div>
        <div class="tab" onclick="switchSection('XE-G')">XE-G: Food Tech</div>
    </div>

    <div class="container">
        <div class="q-area">
            <div class="q-header">
                <div>
                    <span class="q-badge" id="disp-type">MCQ</span>
                    <strong style="font-size: 1.4rem;">Question <span id="disp-num">1</span></strong>
                    <span style="color:#6c757d; font-size:0.9rem; margin-left:10px;">ID: <span id="disp-qid"></span></span>
                </div>
                <div style="color: var(--success); font-weight: bold; font-size:1.1rem;" id="disp-marks">+1 Mark</div>
            </div>
            <div class="q-text" id="disp-text"></div>
            <div class="options" id="disp-options"></div>
        </div>

        <div class="sidebar">
            <div class="user-panel">
                <div style="font-weight:bold; font-size:1.2rem;">Candidate Console</div>
                <div style="font-size:0.9rem; color:#6c757d; margin-top:5px;" id="user-id-disp">Guest User</div>
            </div>
            <div class="palette" id="palette"></div>
            <div style="padding: 20px; border-top: 1px solid #dee2e6; background: #f8f9fa;">
                <button class="btn btn-submit" onclick="submitExam()">Submit & Upload</button>
            </div>
        </div>
    </div>

    <footer>
        <button class="btn btn-prev" onclick="nav(-1)">Previous</button>
        <button class="btn btn-next" onclick="nav(1)">Save & Next</button>
    </footer>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary);">Exam Submitted Successfully</h2>
            <p>Your data has been processed.</p>
            
            <div class="score-box">
                <div class="score-row" style="font-weight:bold; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <span>Total Score</span>
                    <span id="final-total" style="color:var(--primary)">0</span>
                </div>
                <div class="score-row"><span>Mathematics (XE-A)</span> <span id="score-a">0</span></div>
                <div class="score-row"><span>Materials Science (XE-C)</span> <span id="score-c">0</span></div>
                <div class="score-row"><span>Food Tech (XE-G)</span> <span id="score-g">0</span></div>
            </div>

            <button class="btn btn-next" onclick="location.reload()">Close & Reset</button>
        </div>
    </div>

    <div id="loadingModal" class="modal" style="z-index: 3000;">
        <div style="color:white; font-size:1.5rem; font-weight:bold;">
            Uploading Results... <br>
            <span style="font-size:1rem; font-weight:normal;">Please wait...</span>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // --- FIREBASE CONFIGURATION ---
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your specific configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmKDzGKE9FV9A7wHG21yAbgzIYMep4iHo",
            authDomain: "rec-gate-2026.firebaseapp.com",
            projectId: "rec-gate-2026",
            storageBucket: "rec-gate-2026.firebasestorage.app",
            messagingSenderId: "966656816540",
            appId: "1:966656816540:web:f07b7b6e2cb27114cc8459"
        };

        // Initialize Firebase safely
        let dbRef = null;
        try {
            const app = initializeApp(firebaseConfig);
            dbRef = getFirestore(app);
            console.log("Firebase Initialized Successfully for project: " + firebaseConfig.projectId);
        } catch (e) {
            console.warn("Firebase Init Error: Running in Offline Mode.", e);
        }

        // Expose functions to global window scope
        window.submitExam = submitExam;
        window.nav = nav;
        window.switchSection = switchSection;
        window.save = save;
        window.saveMSQ = saveMSQ;
        window.saveNAT = saveNAT;
        window.loadQ = loadQ;

        // ==========================================
        // --- DATA & LOGIC ---
        // ==========================================
        const rawData = [
            // === XE-A: ENGINEERING MATHEMATICS ===
            { id: "A1", section: "XE-A", type: "MCQ", marks: 1, q: "Let $S = \\{ AX : A = \\begin{bmatrix} 2 & -4 \\\\ 1 & 1 \\\\ 1 & -1 \\end{bmatrix} \\text{ and } X = \\begin{bmatrix} x_1 \\\\ x_2 \\end{bmatrix} \\}$. If $\\begin{bmatrix} -1 \\\\ \\alpha \\\\ 1 \\end{bmatrix} \\in S$, then the value of $\\alpha$ is:", opts: ["-4", "-2", "2", "4"], correct: 3 },
            { id: "A2", section: "XE-A", type: "MCQ", marks: 1, q: "Let C be the boundary of the region $R: 0 \\le x \\le \\pi, 0 \\le y \\le \\sin x$ in the xy-plane and $\\alpha$ be the area of region R. If C traverses once in counter-clockwise direction, the value of $\\oint_C (2y dx + 5x dy)$ is:", opts: ["$\\alpha$", "$2\\alpha$", "$3\\alpha$", "$4\\alpha$"], correct: 2 },
            { id: "A3", section: "XE-A", type: "MCQ", marks: 1, q: "Given $i = \\sqrt{-1}$. The value of $\\lim_{z \\to e^{\\pi i/3}} \\frac{z^3 + 1}{z^4 + z^2 + 1}$ is:", opts: ["$\\frac{3}{4} + i\\frac{\\sqrt{3}}{4}$", "$\\frac{3}{4} - i\\frac{\\sqrt{3}}{4}$", "$\\frac{-3}{4} + i\\frac{\\sqrt{3}}{4}$", "$\\frac{-3}{4} - i\\frac{\\sqrt{3}}{4}$"], correct: 1 },
            { id: "A4", section: "XE-A", type: "NAT", marks: 1, q: "Let $f(x)$ be a non-negative continuous function. If area under $y=f(x)$ from $x=0$ to $x=a$ is $\\frac{a^2}{2} + \\frac{a}{2}\\sin a + \\frac{\\pi}{2}\\cos a - \\frac{\\pi}{2}$, then find $f(\\frac{\\pi}{2})$.", correct: [0.5, 0.5] },
            { id: "A5", section: "XE-A", type: "NAT", marks: 1, q: "If the numerical approximation of $\\int_0^4 2^{ax} dx$ using Trapezoidal rule with two subintervals is 9, find the value of $a$.", correct: [0.5, 0.5] },
            { id: "A6", section: "XE-A", type: "NAT", marks: 1, q: "Transformation $y(x) = e^x v(x)$ reduces $x \\frac{d^2y}{dx^2} + 2(1-x)\\frac{dy}{dx} + (x-2)y = 0$ to $\\alpha x \\frac{d^2v}{dx^2} + 2\\beta \\frac{dv}{dx} + 3\\gamma v = 0$. Find the arithmetic mean of $\\alpha, \\beta, \\gamma$.", correct: [0.665, 0.668] },
            { id: "A7", section: "XE-A", type: "NAT", marks: 1, q: "A person speaks truth 3 out of 4 times. He throws a fair dice and reports outcome is 5. Probability that outcome is really 5 is:", correct: [0.375, 0.375] },
            { id: "A8", section: "XE-A", type: "MCQ", marks: 2, q: "Let $f(x,y) = x^4 + y^4 - 2x^2 + 4xy - 2y^2 + a$. Which statement is TRUE for all a?", opts: ["(0,0) is not a stationary point", "Local maxima at (0,0)", "Local minima at (0,0)", "Saddle point at (0,0)"], correct: 3 },
            { id: "A9", section: "XE-A", type: "MCQ", marks: 2, q: "Let $u(x,y) = (x^2 - y^2)v(x,y)$ satisfy Laplace equation. Which is TRUE?", opts: ["$x \\frac{\\partial v}{\\partial x} - y \\frac{\\partial v}{\\partial y} = 0$", "$x \\frac{\\partial v}{\\partial x} + y \\frac{\\partial v}{\\partial y} = 0$", "$x \\frac{\\partial v}{\\partial y} - y \\frac{\\partial v}{\\partial x} = 0$", "$x \\frac{\\partial v}{\\partial y} + y \\frac{\\partial v}{\\partial x} = 0$"], correct: 0 },
            { id: "A10", section: "XE-A", type: "NAT", marks: 2, q: "A is $7\\times7$ matrix, $C_A(\\lambda) = \\lambda^2(\\lambda-1)^\\alpha(\\lambda+2)^\\beta$. If A is diagonalizable and $rank(A)=rank(A+2I)$, find $rank(A-I)$.", correct: [4, 4] },
            { id: "A11", section: "XE-A", type: "NAT", marks: 2, q: "Line integral calculation along C1 (line) and C2 (arc). Value of $\\alpha^2 + \\beta^2$.", correct: [0.32, 0.32] },

            // === XE-C: MATERIALS SCIENCE ===
            { id: "C1", section: "XE-C", type: "MCQ", marks: 1, q: "Condition for $\\alpha$ and $\\beta$ phases to be in equilibrium in a two-component system at constant T and P is:", opts: ["Entropy maximum", "Gibbs min and $\\mu_A^\\alpha = \\mu_B^\\alpha$", "Gibbs min and $\\mu_A^\\alpha = \\mu_A^\\beta, \\mu_B^\\alpha = \\mu_B^\\beta$", "Helmholtz minimum"], correct: 2 },
            { id: "C2", section: "XE-C", type: "MCQ", marks: 1, q: "Amino acids react to form peptides and proteins. This process is known as:", opts: ["Addition polymerization", "Nucleophilic substitution", "Condensation polymerization", "Hydration"], correct: 2 },
            { id: "C3", section: "XE-C", type: "MCQ", marks: 1, q: "The most favoured slip system in face centered cubic metal is:", opts: ["{111} <110>", "{110} <111>", "{111} <112>", "{111} <110>"], correct: 3 },
            { id: "C4", section: "XE-C", type: "MCQ", marks: 1, q: "Dielectric constant of a material at ultraviolet frequencies is mainly due to:", opts: ["Dipolar polarizability", "Ionic polarizability", "Electronic polarizability", "Interfacial polarizability"], correct: 2 },
            { id: "C5", section: "XE-C", type: "MCQ", marks: 1, q: "Match Transformations:<br>P. Eutectoid (1. No diffusion)<br>Q. Martensitic (2. One solid -> Two solids)<br>R. Precipitation (3. Supersaturated solid solution)", opts: ["P-2, Q-3, R-1", "P-1, Q-2, R-3", "P-2, Q-1, R-3", "P-3, Q-2, R-1"], correct: 2 },
            { id: "C6", section: "XE-C", type: "MCQ", marks: 1, q: "In SEM, resolution of BSE image is poorer than SE image because:", opts: ["Energy of BSE is lower", "Sampling volume of BSE is larger", "Yield of BSE is lower", "Sampling volume of SE is larger"], correct: 1 },
            { id: "C7", section: "XE-C", type: "MCQ", marks: 1, q: "Which deposition conditions favour larger grains in thin film?", opts: ["Low rate, Low T", "Low rate, High T", "High rate, Low T", "High rate, High T"], correct: 1 },
            { id: "C8", section: "XE-C", type: "MSQ", marks: 1, q: "Metal MP $600^\\circ C$. Solidify at 500, 400, or 300. Critical nuclei size is:", opts: ["Same for 400 and 500", "Smaller at 400 than 500", "Larger at 400 than 500", "Smallest at 300"], correct: [1, 3] },
            { id: "C9", section: "XE-C", type: "NAT", marks: 1, q: "Magnet mass 50g, Moment $4.2\\times 10^{-7} Am^2$. Density $7.2 g/cm^3$. Calculate Intensity of Magnetization in $Am^{-1}$.", correct: [0.058, 0.063] },
            { id: "C10", section: "XE-C", type: "MCQ", marks: 2, q: "Match SEM signals:<br>P. Secondary e- (1. Crystallographic)<br>Q. Backscattered (2. Fracture analysis)<br>R. Characteristic X-rays (3. Composition)<br>S. Diffracted BSE (4. Phase contrast)", opts: ["P-3, Q-2, R-1, S-4", "P-2, Q-4, R-3, S-1", "P-1, Q-3, R-2, S-4", "P-4, Q-2, R-1, S-3"], correct: 1 },
            { id: "C11", section: "XE-C", type: "MCQ", marks: 2, q: "Match Heat Treatments:<br>P. Quenching (1. Hardens steel)<br>Q. Annealing (2. Softens cold work)<br>R. Tempering (3. Toughens)<br>S. Carburizing (4. Hardens surface)", opts: ["P-3, Q-2, R-1, S-4", "P-2, Q-4, R-3, S-1", "P-1, Q-2, R-3, S-4", "P-1, Q-3, R-4, S-2"], correct: 2 },
            { id: "C12", section: "XE-C", type: "MCQ", marks: 2, q: "A co-joined cross-ply laminate composite is distorted upon heating. What are the resultant shapes?", opts: ["Shape A", "Shape B", "Shape C", "Shape D"], correct: 2 },
            { id: "C13", section: "XE-C", type: "MSQ", marks: 2, q: "X-ray diffraction peak broadening enables estimation of:", opts: ["Crystallite size", "Microstrain", "Precise lattice parameter", "Residual macrostress"], correct: [0, 1] },
            { id: "C14", section: "XE-C", type: "NAT", marks: 2, q: "Fe 10 at% C austenite (fcc), lattice parameter 4 Angstrom. Calculate density.", correct: [5.85, 6.00] },
            { id: "C15", section: "XE-C", type: "NAT", marks: 2, q: "Alpha to Beta transformation thermodynamics calculation. Pressure required?", correct: [9600, 9800] },
            { id: "C16", section: "XE-C", type: "NAT", marks: 2, q: "Binary A-B alloy. Ratio of alpha/beta wt% is 4. Wt% A in alpha=70, beta=20. Find wt% B in alloy.", correct: [38, 42] },
            { id: "C17", section: "XE-C", type: "NAT", marks: 2, q: "Ti allotropic transformation HCP to BCC. Calculate % volume change.", correct: [3.4, 4.8] },
            { id: "C18", section: "XE-C", type: "NAT", marks: 2, q: "Vickers hardness calculation. Load 10kg, diagonal 0.5mm.", correct: [71, 77] },
            { id: "C19", section: "XE-C", type: "NAT", marks: 2, q: "Drift mobility n-type Si. Calculate conductivity.", correct: [210, 220] },
            { id: "C20", section: "XE-C", type: "NAT", marks: 2, q: "Graphite thermal expansion volume increase calculation.", correct: [0.60, 0.62] },
            { id: "C21", section: "XE-C", type: "NAT", marks: 2, q: "Ceramic sintering. Green compact porosity 18%. Calculate green compact side.", correct: [2.10, 2.14] },
            { id: "C22", section: "XE-C", type: "NAT", marks: 2, q: "Corrosion rate calculation (Tafel slope).", correct: [0.1, 0.1] },

            // === XE-G: FOOD TECHNOLOGY ===
            { id: "G1", section: "XE-G", type: "MCQ", marks: 1, q: "In typical bacterial growth curve, first order kinetics is observed in:", opts: ["Lag phase", "Log phase", "Stationary phase", "Death phase"], correct: 1 },
            { id: "G2", section: "XE-G", type: "MCQ", marks: 1, q: "Which microorganism is NOT a causative agent for food borne diseases?", opts: ["Campylobacter jejuni", "Clostridium perfringens", "Norovirus", "Borrelia burgdorferi"], correct: 3 },
            { id: "G3", section: "XE-G", type: "MCQ", marks: 1, q: "Which is NOT a fermented food?", opts: ["Tofu", "Vinegar", "Sauerkraut", "Tempeh"], correct: 0 },
            { id: "G4", section: "XE-G", type: "MCQ", marks: 1, q: "Protein Efficiency Ratio (PER) is defined as:", opts: ["% absorbed N retained", "Weight gain per gram protein intake", "Ratio essential/non-essential AA", "% in vitro digestibility"], correct: 1 },
            { id: "G6", section: "XE-G", type: "MCQ", marks: 1, q: "Enzyme involved in proteolysis of casein in cheese during aging?", opts: ["Myrosinase", "Alliinases", "Cathepsin", "Plasmin"], correct: 3 },
            { id: "G7", section: "XE-G", type: "MCQ", marks: 1, q: "Which enzyme sequentially releases maltose from starch?", opts: ["Alpha-Amylase", "Beta-Amylase", "Glucoamylase", "Pullulanase"], correct: 3 },
            { id: "G8", section: "XE-G", type: "MCQ", marks: 1, q: "UHT pasteurization of milk is achieved by heating at:", opts: ["145 F for 30 min", "161 F for 15 sec", "280 F for 2 sec", "400 F for 15 sec"], correct: 2 },
            { id: "G9", section: "XE-G", type: "MCQ", marks: 1, q: "Bittering agent in grapefruit formed after juice extraction under acidic conditions:", opts: ["Quinine", "Theobromine", "Isohumulone", "Limonin"], correct: 3 },
            { id: "G10", section: "XE-G", type: "MCQ", marks: 2, q: "Conversion of pyruvate to lactic acid in homolactic fermentation is catalyzed by:", opts: ["Lactate dehydrogenase", "Pyruvate dehydrogenase", "Lactase", "Pyruvate decarboxylase"], correct: 0 },
            { id: "G11", section: "XE-G", type: "MCQ", marks: 2, q: "Which statement is INCORRECT regarding CAP/MAP?", opts: ["Limit microbial/biochemical activities", "Gas composition in MAP is continuously monitored/regulated", "CAP implies greater precision than MAP", "MAP relies on product respiration and film permeation"], correct: 1 },
            { id: "G12", section: "XE-G", type: "MCQ", marks: 2, q: "Match Unit Operation :<br>P. Hydrogenation (1. Removal of soft wax)<br>Q. Blanching (2. Shortening of fat)<br>R. Leaching (3. Inactivation of enzyme)<br>S. Winterization (4. Separation of dye)", opts: ["P-2, Q-4, R-2, S-1", "P-2, Q-3, R-4, S-1", "P-4, Q-1, R-2, S-3", "P-4, Q-2, R-1, S-3"], correct: 1 },
            { id: "G13", section: "XE-G", type: "MSQ", marks: 2, q: "Correct pair of GRAS preservative, organism, and food matrix:", opts: ["Sodium lactate-Bacteria-Meats", "Caprylic acid-Insects-Cheese wraps", "Dehydroacetic acid-Molds-Squash", "Sodium nitrite-Clostridia-Meat curing"], correct: [0, 3] },
            { id: "G14", section: "XE-G", type: "MSQ", marks: 2, q: "Correct pair of pigment and color:", opts: ["Carotene - Yellow/orange - Peppers", "Betanin - Purple/red - Cactus pear", "Lycopene - Red - Beets", "Flavanols - Orange - Cauliflower"], correct: [0, 1] },
            { id: "G15", section: "XE-G", type: "MSQ", marks: 2, q: "Which of the following compounds act as anti-nutritional factors?", opts: ["Phytate", "Isoflavones", "Trypsin Inhibitor", "Resveratrol"], correct: [0, 2] },
            { id: "G16", section: "XE-G", type: "MSQ", marks: 2, q: "Commonly used media in supercritical fluid extraction of spices/tea:", opts: ["Water", "Carbon dioxide", "Dichloromethane", "Carbon dioxide with Ethanol"], correct: [0, 1, 3] },
            { id: "G17", section: "XE-G", type: "MSQ", marks: 2, q: "Which of the following expressions represent the Reynolds number of a fluid flowing through a uniform circular cross section pipe?", opts: ["Density-Velocity-Diameter / Dynamic Viscosity", "Average Velocity-Diameter / Kinematic Viscosity", "Dynamic Viscosity / Average Velocity-Density-Diameter", "Kinematic Viscosity / Average Velocity-Diameter"], correct: [0, 1] },
            { id: "G18", section: "XE-G", type: "MSQ", marks: 2, q: "Which of the following combinations of analytical equipment, property measured and food property are correct?", opts: ["Particle size analyzer - particle size distribution - span value", "Texture profile analyzer - morphology - chewiness", "Differential scanning calorimeter - glass transition temperature - degree of caking", "Capillary viscometer - viscosity - sensory"], correct: [0, 2] },
            { id: "G19", section: "XE-G", type: "MSQ", marks: 2, q: "Choose the correct pair(s) of Governing Law and corresponding application(s)", opts: ["Hagen Poiseuille law - Pressure drop", "Rittinger's law - Vapour pressure", "Stefan Boltzmann law - Radiation heat transfer", "Raoult's law - Size reduction"], correct: [0, 2] },
            { id: "G20", section: "XE-G", type: "NAT", marks: 2, q: "Evaporator calc: 10% to 40% solids, 3600 kg/hr feed. Heat transfer rate?", correct: [1900, 1910] },
            { id: "G21", section: "XE-G", type: "NAT", marks: 2, q: "Tray dryer humidity calculation.", correct: [0.135, 0.150] },
            { id: "G22", section: "XE-G", type: "NAT", marks: 2, q: "Cold storage potato respiration load calculation.", correct: [2.20, 2.40] }
        ];

        let responses = {};
        let currentSec = 'XE-A';
        let currentIdx = 0;
        let visited = new Set();
        let questions = [];

        function init() {
            const user = localStorage.getItem("REC_USER_ID") || "GUEST";
            document.getElementById("user-id-disp").innerText = user;

            switchSection('XE-A');
            
            setInterval(() => {
                let t = document.getElementById('timer');
                let [m, s] = t.innerText.split(':').map(Number);
                if (s === 0) { if (m === 0) return; m--; s = 59; } else s--;
                t.innerText = `${m}:${s < 10 ? '0' + s : s}`;
            }, 1000);
        }

        function switchSection(sec) {
            currentSec = sec;
            questions = rawData.filter(q => q.section === sec);
            currentIdx = 0;
            document.querySelectorAll('.tab').forEach(t => {
                t.className = t.innerText.includes(sec) ? 'tab active' : 'tab';
            });
            renderPalette();
            loadQ(0);
        }

        function loadQ(idx) {
            currentIdx = idx;
            let q = questions[idx];
            visited.add(q.id);
            
            document.getElementById('disp-num').innerText = idx + 1;
            document.getElementById('disp-qid').innerText = q.id;
            document.getElementById('disp-type').innerText = q.type;
            document.getElementById('disp-marks').innerText = `+${q.marks} Mark${q.marks > 1 ? 's' : ''}`;
            document.getElementById('disp-text').innerHTML = q.q;

            let optsDiv = document.getElementById('disp-options');
            optsDiv.innerHTML = '';

            let saved = responses[q.id];

            if (q.type === 'MCQ') {
                q.opts.forEach((opt, i) => {
                    let checked = saved === i ? 'checked' : '';
                    optsDiv.innerHTML += `<label class="option-label"><input type="radio" name="ans" value="${i}" onclick="save(${i})" ${checked}> ${opt}</label>`;
                });
            } else if (q.type === 'MSQ') {
                q.opts.forEach((opt, i) => {
                    let checked = (saved || []).includes(i) ? 'checked' : '';
                    optsDiv.innerHTML += `<label class="option-label"><input type="checkbox" value="${i}" onclick="saveMSQ(this, ${i})" ${checked}> ${opt}</label>`;
                });
            } else if (q.type === 'NAT') {
                optsDiv.innerHTML = `<input type="number" class="nat-input" onblur="saveNAT(this)" value="${saved || ''}" placeholder="Enter Answer">`;
            }
            
            if(window.MathJax) MathJax.typeset();
            renderPalette();
        }

        function save(val) { responses[questions[currentIdx].id] = val; renderPalette(); }
        
        function saveMSQ(el, val) {
            let id = questions[currentIdx].id;
            let arr = responses[id] || [];
            if (el.checked) arr.push(val); else arr = arr.filter(x => x !== val);
            responses[id] = arr;
            renderPalette();
        }
        
        function saveNAT(el) { 
            let val = parseFloat(el.value);
            if (!isNaN(val)) responses[questions[currentIdx].id] = val; 
            renderPalette();
        }

        function renderPalette() {
            let p = document.getElementById('palette');
            p.innerHTML = '';
            questions.forEach((q, i) => {
                let cls = 'p-btn';
                if (i === currentIdx) cls += ' active';
                if (responses[q.id] !== undefined) cls += ' answered';
                else if (visited.has(q.id)) cls += ' visited';
                p.innerHTML += `<div class="${cls}" onclick="loadQ(${i})">${i + 1}</div>`;
            });
        }

        function nav(dir) {
            let next = currentIdx + dir;
            if (next >= 0 && next < questions.length) loadQ(next);
        }

        // ==========================================
        // --- SCORE & UPLOAD LOGIC ---
        // ==========================================
        async function submitExam() {
            if (!confirm("Are you sure you want to submit? This will upload your data.")) return;

            const modal = document.getElementById('loadingModal');
            modal.style.display = 'flex';

            let totalScore = 0;
            let sectionScores = { "XE-A": 0, "XE-C": 0, "XE-G": 0 };
            
            rawData.forEach(q => {
                let ans = responses[q.id];
                let points = 0;
                
                if (ans !== undefined) {
                    let isCorrect = false;
                    
                    if (q.type === 'MCQ' && ans === q.correct) isCorrect = true;
                    else if (q.type === 'MSQ' && JSON.stringify(ans.sort()) === JSON.stringify(q.correct.sort())) isCorrect = true;
                    else if (q.type === 'NAT' && ans >= q.correct[0] && ans <= q.correct[1]) isCorrect = true;
                    
                    if (isCorrect) {
                        points = q.marks;
                    } else if (q.type === 'MCQ') {
                        // Optional: Negative Marking
                        points = -(q.marks / 3);
                    }
                }

                if (points !== 0) {
                    totalScore += points;
                    if (sectionScores[q.section] !== undefined) sectionScores[q.section] += points;
                }
            });

            // Update UI
            document.getElementById('final-total').innerText = totalScore.toFixed(2);
            document.getElementById('score-a').innerText = sectionScores["XE-A"].toFixed(2);
            document.getElementById('score-c').innerText = sectionScores["XE-C"].toFixed(2);
            document.getElementById('score-g').innerText = sectionScores["XE-G"].toFixed(2);

            // Upload Logic with Timeout Fallback
            if (dbRef) {
                const payload = {
                    student_id: localStorage.getItem("REC_USER_ID") || "GUEST",
                    exam_name: "GATE_2021_XE",
                    total_score: totalScore,
                    section_scores: sectionScores,
                    timestamp: new Date().toISOString(),
                    responses: JSON.stringify(responses)
                };

                try {
                    // Timeout Promise
                    const timeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Upload Timeout")), 5000)
                    );
                    
                    // Race between Upload and Timeout
                    await Promise.race([
                        addDoc(collection(dbRef, "exam_results"), payload),
                        timeout
                    ]);
                    
                    console.log("Uploaded successfully");
                } catch (e) {
                    console.warn("Upload skipped or failed (likely offline or missing keys). Showing local results.");
                }
            }

            modal.style.display = 'none';
            document.getElementById('resultModal').style.display = 'flex';
        }

        init();
    </script>
</body>
</html>
